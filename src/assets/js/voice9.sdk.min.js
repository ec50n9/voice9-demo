!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).Voice9=t()}(this,(function(){"use strict";!function(e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).adapter=e()}((function(){return function e(t,n,r){function o(a,s){if(!n[a]){if(!t[a]){var c="function"==typeof require&&require;if(!s&&c)return c(a,!0);if(i)return i(a,!0);throw(c=new Error("Cannot find module '"+a+"'")).code="MODULE_NOT_FOUND",c}c=n[a]={exports:{}},t[a][0].call(c.exports,(function(e){return o(t[a][1][e]||e)}),c,c.exports,e,t,n,r)}return n[a].exports}for(var i="function"==typeof require&&require,a=0;a<r.length;a++)o(r[a]);return o}({1:[function(e,t,n){e=(0,e("./adapter_factory.js").adapterFactory)({window:"undefined"==typeof window?void 0:window}),t.exports=e},{"./adapter_factory.js":2}],2:[function(e,t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.adapterFactory=function(){var e=(0<arguments.length&&void 0!==arguments[0]?arguments[0]:{}).window,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{shimChrome:!0,shimFirefox:!0,shimSafari:!0},n=r.log,d=r.detectBrowser(e),l={browserDetails:d,commonShim:s,extractVersion:r.extractVersion,disableLog:r.disableLog,disableWarnings:r.disableWarnings,sdp:c};switch(d.browser){case"chrome":if(!o||!o.shimPeerConnection||!t.shimChrome)return n("Chrome shim is not included in this adapter release."),l;if(null===d.version)return n("Chrome shim can not determine version, not shimming."),l;n("adapter.js shimming chrome."),l.browserShim=o,s.shimAddIceCandidateNullOrEmpty(e,d),s.shimParameterlessSetLocalDescription(e,d),o.shimGetUserMedia(e,d),o.shimMediaStream(e,d),o.shimPeerConnection(e,d),o.shimOnTrack(e,d),o.shimAddTrackRemoveTrack(e,d),o.shimGetSendersWithDtmf(e,d),o.shimGetStats(e,d),o.shimSenderReceiverGetStats(e,d),o.fixNegotiationNeeded(e,d),s.shimRTCIceCandidate(e,d),s.shimConnectionState(e,d),s.shimMaxMessageSize(e,d),s.shimSendThrowTypeError(e,d),s.removeExtmapAllowMixed(e,d);break;case"firefox":if(!i||!i.shimPeerConnection||!t.shimFirefox)return n("Firefox shim is not included in this adapter release."),l;n("adapter.js shimming firefox."),l.browserShim=i,s.shimAddIceCandidateNullOrEmpty(e,d),s.shimParameterlessSetLocalDescription(e,d),i.shimGetUserMedia(e,d),i.shimPeerConnection(e,d),i.shimOnTrack(e,d),i.shimRemoveStream(e,d),i.shimSenderGetStats(e,d),i.shimReceiverGetStats(e,d),i.shimRTCDataChannel(e,d),i.shimAddTransceiver(e,d),i.shimGetParameters(e,d),i.shimCreateOffer(e,d),i.shimCreateAnswer(e,d),s.shimRTCIceCandidate(e,d),s.shimConnectionState(e,d),s.shimMaxMessageSize(e,d),s.shimSendThrowTypeError(e,d);break;case"safari":if(!a||!t.shimSafari)return n("Safari shim is not included in this adapter release."),l;n("adapter.js shimming safari."),l.browserShim=a,s.shimAddIceCandidateNullOrEmpty(e,d),s.shimParameterlessSetLocalDescription(e,d),a.shimRTCIceServerUrls(e,d),a.shimCreateOfferLegacy(e,d),a.shimCallbacksAPI(e,d),a.shimLocalStreamsAPI(e,d),a.shimRemoteStreamsAPI(e,d),a.shimTrackEventTransceiver(e,d),a.shimGetUserMedia(e,d),a.shimAudioContext(e,d),s.shimRTCIceCandidate(e,d),s.shimMaxMessageSize(e,d),s.shimSendThrowTypeError(e,d),s.removeExtmapAllowMixed(e,d);break;default:n("Unsupported browser!")}return l};var r=d(e("./utils")),o=d(e("./chrome/chrome_shim")),i=d(e("./firefox/firefox_shim")),a=d(e("./safari/safari_shim")),s=d(e("./common_shim")),c=d(e("sdp"));function d(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}},{"./chrome/chrome_shim":3,"./common_shim":6,"./firefox/firefox_shim":7,"./safari/safari_shim":10,"./utils":11,sdp:12}],3:[function(e,t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.shimGetDisplayMedia=n.shimGetUserMedia=void 0;var r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},o=e("./getusermedia");Object.defineProperty(n,"shimGetUserMedia",{enumerable:!0,get:function(){return o.shimGetUserMedia}});var i=e("./getdisplaymedia");Object.defineProperty(n,"shimGetDisplayMedia",{enumerable:!0,get:function(){return i.shimGetDisplayMedia}}),n.shimMediaStream=function(e){e.MediaStream=e.MediaStream||e.webkitMediaStream},n.shimOnTrack=function(e){var t;"object"!==(void 0===e?"undefined":r(e))||!e.RTCPeerConnection||"ontrack"in e.RTCPeerConnection.prototype?a.wrapPeerConnectionEvent(e,"track",(function(e){return e.transceiver||Object.defineProperty(e,"transceiver",{value:{receiver:e.receiver}}),e})):(Object.defineProperty(e.RTCPeerConnection.prototype,"ontrack",{get:function(){return this._ontrack},set:function(e){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=e)},enumerable:!0,configurable:!0}),t=e.RTCPeerConnection.prototype.setRemoteDescription,e.RTCPeerConnection.prototype.setRemoteDescription=function(){var n=this;return this._ontrackpoly||(this._ontrackpoly=function(t){t.stream.addEventListener("addtrack",(function(r){var o=e.RTCPeerConnection.prototype.getReceivers?n.getReceivers().find((function(e){return e.track&&e.track.id===r.track.id})):{track:r.track},i=new Event("track");i.track=r.track,i.receiver=o,i.transceiver={receiver:o},i.streams=[t.stream],n.dispatchEvent(i)})),t.stream.getTracks().forEach((function(r){var o=e.RTCPeerConnection.prototype.getReceivers?n.getReceivers().find((function(e){return e.track&&e.track.id===r.id})):{track:r},i=new Event("track");i.track=r,i.receiver=o,i.transceiver={receiver:o},i.streams=[t.stream],n.dispatchEvent(i)}))},this.addEventListener("addstream",this._ontrackpoly)),t.apply(this,arguments)})},n.shimGetSendersWithDtmf=function(e){var t,n,o,i,a,s;"object"===(void 0===e?"undefined":r(e))&&e.RTCPeerConnection&&!("getSenders"in e.RTCPeerConnection.prototype)&&"createDTMFSender"in e.RTCPeerConnection.prototype?(t=function(e,t){return{track:t,get dtmf(){return void 0===this._dtmf&&("audio"===t.kind?this._dtmf=e.createDTMFSender(t):this._dtmf=null),this._dtmf},_pc:e}},e.RTCPeerConnection.prototype.getSenders||(e.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()},n=e.RTCPeerConnection.prototype.addTrack,e.RTCPeerConnection.prototype.addTrack=function(e,r){var o=n.apply(this,arguments);return o||(o=t(this,e),this._senders.push(o)),o},o=e.RTCPeerConnection.prototype.removeTrack,e.RTCPeerConnection.prototype.removeTrack=function(e){o.apply(this,arguments),-1!==(e=this._senders.indexOf(e))&&this._senders.splice(e,1)}),i=e.RTCPeerConnection.prototype.addStream,e.RTCPeerConnection.prototype.addStream=function(e){var n=this;this._senders=this._senders||[],i.apply(this,[e]),e.getTracks().forEach((function(e){n._senders.push(t(n,e))}))},a=e.RTCPeerConnection.prototype.removeStream,e.RTCPeerConnection.prototype.removeStream=function(e){var t=this;this._senders=this._senders||[],a.apply(this,[e]),e.getTracks().forEach((function(e){var n=t._senders.find((function(t){return t.track===e}));n&&t._senders.splice(t._senders.indexOf(n),1)}))}):"object"===(void 0===e?"undefined":r(e))&&e.RTCPeerConnection&&"getSenders"in e.RTCPeerConnection.prototype&&"createDTMFSender"in e.RTCPeerConnection.prototype&&e.RTCRtpSender&&!("dtmf"in e.RTCRtpSender.prototype)&&(s=e.RTCPeerConnection.prototype.getSenders,e.RTCPeerConnection.prototype.getSenders=function(){var e=this,t=s.apply(this,[]);return t.forEach((function(t){return t._pc=e})),t},Object.defineProperty(e.RTCRtpSender.prototype,"dtmf",{get:function(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}}))},n.shimGetStats=function(e){var t;e.RTCPeerConnection&&(t=e.RTCPeerConnection.prototype.getStats,e.RTCPeerConnection.prototype.getStats=function(){var e=this,n=(o=Array.prototype.slice.call(arguments))[0],r=o[1],o=o[2];if(0<arguments.length&&"function"==typeof n)return t.apply(this,arguments);if(0===t.length&&(0===arguments.length||"function"!=typeof n))return t.apply(this,[]);var i=function(e){var t={};return e.result().forEach((function(e){var n={id:e.id,timestamp:e.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[e.type]||e.type};e.names().forEach((function(t){n[t]=e.stat(t)})),t[n.id]=n})),t},a=function(e){return new Map(Object.keys(e).map((function(t){return[t,e[t]]})))};return 2<=arguments.length?t.apply(this,[function(e){r(a(i(e)))},n]):new Promise((function(n,r){t.apply(e,[function(e){n(a(i(e)))},r])})).then(r,o)})},n.shimSenderReceiverGetStats=function(e){var t,n,o,i;"object"===(void 0===e?"undefined":r(e))&&e.RTCPeerConnection&&e.RTCRtpSender&&e.RTCRtpReceiver&&("getStats"in e.RTCRtpSender.prototype||((t=e.RTCPeerConnection.prototype.getSenders)&&(e.RTCPeerConnection.prototype.getSenders=function(){var e=this,n=t.apply(this,[]);return n.forEach((function(t){return t._pc=e})),n}),(n=e.RTCPeerConnection.prototype.addTrack)&&(e.RTCPeerConnection.prototype.addTrack=function(){var e=n.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){var e=this;return this._pc.getStats().then((function(t){return a.filterStats(t,e.track,!0)}))}),"getStats"in e.RTCRtpReceiver.prototype||((o=e.RTCPeerConnection.prototype.getReceivers)&&(e.RTCPeerConnection.prototype.getReceivers=function(){var e=this,t=o.apply(this,[]);return t.forEach((function(t){return t._pc=e})),t}),a.wrapPeerConnectionEvent(e,"track",(function(e){return e.receiver._pc=e.srcElement,e})),e.RTCRtpReceiver.prototype.getStats=function(){var e=this;return this._pc.getStats().then((function(t){return a.filterStats(t,e.track,!1)}))}),"getStats"in e.RTCRtpSender.prototype&&"getStats"in e.RTCRtpReceiver.prototype&&(i=e.RTCPeerConnection.prototype.getStats,e.RTCPeerConnection.prototype.getStats=function(){if(0<arguments.length&&arguments[0]instanceof e.MediaStreamTrack){var t=arguments[0],n=void 0,r=void 0,o=void 0;return this.getSenders().forEach((function(e){e.track===t&&(n?o=!0:n=e)})),this.getReceivers().forEach((function(e){return e.track===t&&(r?o=!0:r=e),e.track===t})),o||n&&r?Promise.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):n?n.getStats():r?r.getStats():Promise.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return i.apply(this,arguments)}))},n.shimAddTrackRemoveTrackWithNative=c,n.shimAddTrackRemoveTrack=function(e,t){if(e.RTCPeerConnection){if(e.RTCPeerConnection.prototype.addTrack&&65<=t.version)return c(e);var n=e.RTCPeerConnection.prototype.getLocalStreams;e.RTCPeerConnection.prototype.getLocalStreams=function(){var e=this,t=n.apply(this);return this._reverseStreams=this._reverseStreams||{},t.map((function(t){return e._reverseStreams[t.id]}))};var r=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(t){var n,o=this;this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},t.getTracks().forEach((function(e){if(o.getSenders().find((function(t){return t.track===e})))throw new DOMException("Track already exists.","InvalidAccessError")})),this._reverseStreams[t.id]||(n=new e.MediaStream(t.getTracks()),this._streams[t.id]=n,this._reverseStreams[n.id]=t,t=n),r.apply(this,[t])};var o=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},o.apply(this,[this._streams[e.id]||e]),delete this._reverseStreams[(this._streams[e.id]||e).id],delete this._streams[e.id]},e.RTCPeerConnection.prototype.addTrack=function(t,n){var r=this;if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");var o=[].slice.call(arguments,1);if(1!==o.length||!o[0].getTracks().find((function(e){return e===t})))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");if(this.getSenders().find((function(e){return e.track===t})))throw new DOMException("Track already exists.","InvalidAccessError");return this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},(o=this._streams[n.id])?(o.addTrack(t),Promise.resolve().then((function(){r.dispatchEvent(new Event("negotiationneeded"))}))):(o=new e.MediaStream([t]),this._streams[n.id]=o,this._reverseStreams[o.id]=n,this.addStream(o)),this.getSenders().find((function(e){return e.track===t}))},["createOffer","createAnswer"].forEach((function(t){var n=e.RTCPeerConnection.prototype[t],r=s({},t,(function(){var e=this,t=arguments;return arguments.length&&"function"==typeof arguments[0]?n.apply(this,[function(n){n=d(e,n),t[0].apply(null,[n])},function(e){t[1]&&t[1].apply(null,e)},arguments[2]]):n.apply(this,arguments).then((function(t){return d(e,t)}))}));e.RTCPeerConnection.prototype[t]=r[t]}));var i=e.RTCPeerConnection.prototype.setLocalDescription;e.RTCPeerConnection.prototype.setLocalDescription=function(){return arguments.length&&arguments[0].type&&(arguments[0]=(e=this,n=(t=arguments[0]).sdp,Object.keys(e._reverseStreams||[]).forEach((function(t){var r=e._reverseStreams[t];t=e._streams[r.id];n=n.replace(new RegExp(r.id,"g"),t.id)})),new RTCSessionDescription({type:t.type,sdp:n}))),i.apply(this,arguments);var e,t,n};var a=Object.getOwnPropertyDescriptor(e.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(e.RTCPeerConnection.prototype,"localDescription",{get:function(){var e=a.get.apply(this);return""===e.type?e:d(this,e)}}),e.RTCPeerConnection.prototype.removeTrack=function(e){var t=this;if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!e._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(e._pc!==this)throw new DOMException("Sender was not created by this connection.","InvalidAccessError");this._streams=this._streams||{};var n=void 0;Object.keys(this._streams).forEach((function(r){t._streams[r].getTracks().find((function(t){return e.track===t}))&&(n=t._streams[r])})),n&&(1===n.getTracks().length?this.removeStream(this._reverseStreams[n.id]):n.removeTrack(e.track),this.dispatchEvent(new Event("negotiationneeded")))}}function d(e,t){var n=t.sdp;return Object.keys(e._reverseStreams||[]).forEach((function(t){var r=e._reverseStreams[t];t=e._streams[r.id];n=n.replace(new RegExp(t.id,"g"),r.id)})),new RTCSessionDescription({type:t.type,sdp:n})}},n.shimPeerConnection=function(e,t){!e.RTCPeerConnection&&e.webkitRTCPeerConnection&&(e.RTCPeerConnection=e.webkitRTCPeerConnection),e.RTCPeerConnection&&t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(t){var n=e.RTCPeerConnection.prototype[t],r=s({},t,(function(){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),n.apply(this,arguments)}));e.RTCPeerConnection.prototype[t]=r[t]}))},n.fixNegotiationNeeded=function(e,t){a.wrapPeerConnectionEvent(e,"negotiationneeded",(function(e){var n=e.target;if(!(t.version<72||n.getConfiguration&&"plan-b"===n.getConfiguration().sdpSemantics)||"stable"===n.signalingState)return e}))};var a=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}(e("../utils.js"));function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function c(e){e.RTCPeerConnection.prototype.getLocalStreams=function(){var e=this;return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map((function(t){return e._shimmedLocalStreams[t][0]}))};var t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,n){if(!n)return t.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};var r=t.apply(this,arguments);return this._shimmedLocalStreams[n.id]?-1===this._shimmedLocalStreams[n.id].indexOf(r)&&this._shimmedLocalStreams[n.id].push(r):this._shimmedLocalStreams[n.id]=[n,r],r};var n=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){var t=this;this._shimmedLocalStreams=this._shimmedLocalStreams||{},e.getTracks().forEach((function(e){if(t.getSenders().find((function(t){return t.track===e})))throw new DOMException("Track already exists.","InvalidAccessError")}));var r=this.getSenders();n.apply(this,arguments);var o=this.getSenders().filter((function(e){return-1===r.indexOf(e)}));this._shimmedLocalStreams[e.id]=[e].concat(o)};var r=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[e.id],r.apply(this,arguments)};var o=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){var t=this;return this._shimmedLocalStreams=this._shimmedLocalStreams||{},e&&Object.keys(this._shimmedLocalStreams).forEach((function(n){var r=t._shimmedLocalStreams[n].indexOf(e);-1!==r&&t._shimmedLocalStreams[n].splice(r,1),1===t._shimmedLocalStreams[n].length&&delete t._shimmedLocalStreams[n]})),o.apply(this,arguments)}}},{"../utils.js":11,"./getdisplaymedia":4,"./getusermedia":5}],4:[function(e,t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.shimGetDisplayMedia=function(e,t){e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||e.navigator.mediaDevices&&("function"==typeof t?e.navigator.mediaDevices.getDisplayMedia=function(n){return t(n).then((function(t){var r=n.video&&n.video.width,o=n.video&&n.video.height,i=n.video&&n.video.frameRate;return n.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:t,maxFrameRate:i||3}},r&&(n.video.mandatory.maxWidth=r),o&&(n.video.mandatory.maxHeight=o),e.navigator.mediaDevices.getUserMedia(n)}))}:console.error("shimGetDisplayMedia: getSourceId argument is not a function"))}},{}],5:[function(e,t,n){Object.defineProperty(n,"__esModule",{value:!0});var r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};n.shimGetUserMedia=function(e,t){var n,i,a,s,c=e&&e.navigator;c.mediaDevices&&(n=function(e){if("object"!==(void 0===e?"undefined":r(e))||e.mandatory||e.optional)return e;var t={};return Object.keys(e).forEach((function(n){var o,i,a;"require"!==n&&"advanced"!==n&&"mediaSource"!==n&&(void 0!==(o="object"===r(e[n])?e[n]:{ideal:e[n]}).exact&&"number"==typeof o.exact&&(o.min=o.max=o.exact),i=function(e,t){return e?e+t.charAt(0).toUpperCase()+t.slice(1):"deviceId"===t?"sourceId":t},void 0!==o.ideal&&(t.optional=t.optional||[],a={},"number"==typeof o.ideal?(a[i("min",n)]=o.ideal,t.optional.push(a),(a={})[i("max",n)]=o.ideal):a[i("",n)]=o.ideal,t.optional.push(a)),void 0!==o.exact&&"number"!=typeof o.exact?(t.mandatory=t.mandatory||{},t.mandatory[i("",n)]=o.exact):["min","max"].forEach((function(e){void 0!==o[e]&&(t.mandatory=t.mandatory||{},t.mandatory[i(e,n)]=o[e])})))})),e.advanced&&(t.optional=(t.optional||[]).concat(e.advanced)),t},i=function(e,i){if(61<=t.version)return i(e);if((e=JSON.parse(JSON.stringify(e)))&&"object"===r(e.audio)&&((s=function(e,t,n){t in e&&!(n in e)&&(e[n]=e[t],delete e[t])})((e=JSON.parse(JSON.stringify(e))).audio,"autoGainControl","googAutoGainControl"),s(e.audio,"noiseSuppression","googNoiseSuppression"),e.audio=n(e.audio)),e&&"object"===r(e.video)){var a=(a=e.video.facingMode)&&("object"===(void 0===a?"undefined":r(a))?a:{ideal:a}),s=t.version<66;if(a&&("user"===a.exact||"environment"===a.exact||"user"===a.ideal||"environment"===a.ideal)&&(!c.mediaDevices.getSupportedConstraints||!c.mediaDevices.getSupportedConstraints().facingMode||s)){delete e.video.facingMode;var d=void 0;if("environment"===a.exact||"environment"===a.ideal?d=["back","rear"]:"user"!==a.exact&&"user"!==a.ideal||(d=["front"]),d)return c.mediaDevices.enumerateDevices().then((function(t){var r=(t=t.filter((function(e){return"videoinput"===e.kind}))).find((function(e){return d.some((function(t){return e.label.toLowerCase().includes(t)}))}));return(r=!r&&t.length&&d.includes("back")?t[t.length-1]:r)&&(e.video.deviceId=a.exact?{exact:r.deviceId}:{ideal:r.deviceId}),e.video=n(e.video),o("chrome: "+JSON.stringify(e)),i(e)}))}e.video=n(e.video)}return o("chrome: "+JSON.stringify(e)),i(e)},a=function(e){return 64<=t.version?e:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[e.name]||e.name,message:e.message,constraint:e.constraint||e.constraintName,toString:function(){return this.name+(this.message&&": ")+this.message}}},c.getUserMedia=function(e,t,n){i(e,(function(e){c.webkitGetUserMedia(e,t,(function(e){n&&n(a(e))}))}))}.bind(c),c.mediaDevices.getUserMedia&&(s=c.mediaDevices.getUserMedia.bind(c.mediaDevices),c.mediaDevices.getUserMedia=function(e){return i(e,(function(e){return s(e).then((function(t){if(e.audio&&!t.getAudioTracks().length||e.video&&!t.getVideoTracks().length)throw t.getTracks().forEach((function(e){e.stop()})),new DOMException("","NotFoundError");return t}),(function(e){return Promise.reject(a(e))}))}))}))};var o=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}(e("../utils.js")).log},{"../utils.js":11}],6:[function(e,t,n){Object.defineProperty(n,"__esModule",{value:!0});var r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};n.shimRTCIceCandidate=function(e){var t;!e.RTCIceCandidate||e.RTCIceCandidate&&"foundation"in e.RTCIceCandidate.prototype||(t=e.RTCIceCandidate,e.RTCIceCandidate=function(e){if("object"===(void 0===e?"undefined":r(e))&&e.candidate&&0===e.candidate.indexOf("a=")&&((e=JSON.parse(JSON.stringify(e))).candidate=e.candidate.substr(2)),e.candidate&&e.candidate.length){var n=new t(e),o=i.default.parseCandidate(e.candidate),a=Object.assign(n,o);return a.toJSON=function(){return{candidate:a.candidate,sdpMid:a.sdpMid,sdpMLineIndex:a.sdpMLineIndex,usernameFragment:a.usernameFragment}},a}return new t(e)},e.RTCIceCandidate.prototype=t.prototype,a.wrapPeerConnectionEvent(e,"icecandidate",(function(t){return t.candidate&&Object.defineProperty(t,"candidate",{value:new e.RTCIceCandidate(t.candidate),writable:"false"}),t})))},n.shimMaxMessageSize=function(e,t){var n;e.RTCPeerConnection&&("sctp"in e.RTCPeerConnection.prototype||Object.defineProperty(e.RTCPeerConnection.prototype,"sctp",{get:function(){return void 0===this._sctp?null:this._sctp}}),n=e.RTCPeerConnection.prototype.setRemoteDescription,e.RTCPeerConnection.prototype.setRemoteDescription=function(){var e,r,o,a;return this._sctp=null,"chrome"===t.browser&&76<=t.version&&"plan-b"===this.getConfiguration().sdpSemantics&&Object.defineProperty(this,"sctp",{get:function(){return void 0===this._sctp?null:this._sctp},enumerable:!0,configurable:!0}),function(e){return!(!e||!e.sdp)&&((e=i.default.splitSections(e.sdp)).shift(),e.some((function(e){return(e=i.default.parseMLine(e))&&"application"===e.kind&&-1!==e.protocol.indexOf("SCTP")})))}(arguments[0])&&(r=function(e){return null===(e=e.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/))||e.length<2||(e=parseInt(e[1],10))!=e?-1:e}(arguments[0]),o=r,a=65536,a=a="firefox"===t.browser?t.version<57?-1===o?16384:2147483637:t.version<60?57===t.version?65535:65536:2147483637:a,r=function(e,n){var r=65536;return"firefox"===t.browser&&57===t.version&&(r=65535),0<(e=i.default.matchPrefix(e.sdp,"a=max-message-size:")).length?r=parseInt(e[0].substr(19),10):"firefox"===t.browser&&-1!==n&&(r=2147483637),r}(arguments[0],r),e=void 0,e=0===a&&0===r?Number.POSITIVE_INFINITY:0===a||0===r?Math.max(a,r):Math.min(a,r),r={},Object.defineProperty(r,"maxMessageSize",{get:function(){return e}}),this._sctp=r),n.apply(this,arguments)})},n.shimSendThrowTypeError=function(e){var t;function n(e,t){var n=e.send;e.send=function(){var r=(r=arguments[0]).length||r.size||r.byteLength;if("open"===e.readyState&&t.sctp&&r>t.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+t.sctp.maxMessageSize+" bytes)");return n.apply(e,arguments)}}e.RTCPeerConnection&&"createDataChannel"in e.RTCPeerConnection.prototype&&(t=e.RTCPeerConnection.prototype.createDataChannel,e.RTCPeerConnection.prototype.createDataChannel=function(){var e=t.apply(this,arguments);return n(e,this),e},a.wrapPeerConnectionEvent(e,"datachannel",(function(e){return n(e.channel,e.target),e})))},n.shimConnectionState=function(e){var t;!e.RTCPeerConnection||"connectionState"in e.RTCPeerConnection.prototype||(t=e.RTCPeerConnection.prototype,Object.defineProperty(t,"connectionState",{get:function(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(t,"onconnectionstatechange",{get:function(){return this._onconnectionstatechange||null},set:function(e){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),e&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=e)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach((function(e){var n=t[e];t[e]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=function(e){var t,n=e.target;return n._lastConnectionState!==n.connectionState&&(n._lastConnectionState=n.connectionState,t=new Event("connectionstatechange",e),n.dispatchEvent(t)),e},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),n.apply(this,arguments)}})))},n.removeExtmapAllowMixed=function(e,t){var n;e.RTCPeerConnection&&("chrome"===t.browser&&71<=t.version||"safari"===t.browser&&605<=t.version||(n=e.RTCPeerConnection.prototype.setRemoteDescription,e.RTCPeerConnection.prototype.setRemoteDescription=function(t){var r;return t&&t.sdp&&-1!==t.sdp.indexOf("\na=extmap-allow-mixed")&&(r=t.sdp.split("\n").filter((function(e){return"a=extmap-allow-mixed"!==e.trim()})).join("\n"),e.RTCSessionDescription&&t instanceof e.RTCSessionDescription?arguments[0]=new e.RTCSessionDescription({type:t.type,sdp:r}):t.sdp=r),n.apply(this,arguments)}))},n.shimAddIceCandidateNullOrEmpty=function(e,t){var n;e.RTCPeerConnection&&e.RTCPeerConnection.prototype&&(n=e.RTCPeerConnection.prototype.addIceCandidate)&&0!==n.length&&(e.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?("chrome"===t.browser&&t.version<78||"firefox"===t.browser&&t.version<68||"safari"===t.browser)&&arguments[0]&&""===arguments[0].candidate?Promise.resolve():n.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())})},n.shimParameterlessSetLocalDescription=function(e,t){var n;e.RTCPeerConnection&&e.RTCPeerConnection.prototype&&(n=e.RTCPeerConnection.prototype.setLocalDescription)&&0!==n.length&&(e.RTCPeerConnection.prototype.setLocalDescription=function(){var e=this,t=arguments[0]||{};if("object"!==(void 0===t?"undefined":r(t))||t.type&&t.sdp)return n.apply(this,arguments);if(!(t={type:t.type,sdp:t.sdp}).type)switch(this.signalingState){case"stable":case"have-local-offer":case"have-remote-pranswer":t.type="offer";break;default:t.type="answer"}return t.sdp||"offer"!==t.type&&"answer"!==t.type?n.apply(this,[t]):("offer"===t.type?this.createOffer:this.createAnswer).apply(this).then((function(t){return n.apply(e,[t])}))})};var o,i=(o=e("sdp"))&&o.__esModule?o:{default:o},a=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}(e("./utils"))},{"./utils":11,sdp:12}],7:[function(e,t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.shimGetDisplayMedia=n.shimGetUserMedia=void 0;var r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},o=e("./getusermedia");Object.defineProperty(n,"shimGetUserMedia",{enumerable:!0,get:function(){return o.shimGetUserMedia}});var i=e("./getdisplaymedia");Object.defineProperty(n,"shimGetDisplayMedia",{enumerable:!0,get:function(){return i.shimGetDisplayMedia}}),n.shimOnTrack=function(e){"object"===(void 0===e?"undefined":r(e))&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get:function(){return{receiver:this.receiver}}})},n.shimPeerConnection=function(e,t){var n,o;"object"===(void 0===e?"undefined":r(e))&&(e.RTCPeerConnection||e.mozRTCPeerConnection)&&(!e.RTCPeerConnection&&e.mozRTCPeerConnection&&(e.RTCPeerConnection=e.mozRTCPeerConnection),t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(t){var n=e.RTCPeerConnection.prototype[t],r=function(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}({},t,(function(){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),n.apply(this,arguments)}));e.RTCPeerConnection.prototype[t]=r[t]})),n={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},o=e.RTCPeerConnection.prototype.getStats,e.RTCPeerConnection.prototype.getStats=function(){var e=(i=Array.prototype.slice.call(arguments))[0],r=i[1],i=i[2];return o.apply(this,[e||null]).then((function(e){if(t.version<53&&!r)try{e.forEach((function(e){e.type=n[e.type]||e.type}))}catch(t){if("TypeError"!==t.name)throw t;e.forEach((function(t,r){e.set(r,Object.assign({},t,{type:n[t.type]||t.type}))}))}return e})).then(r,i)})},n.shimSenderGetStats=function(e){var t,n;"object"===(void 0===e?"undefined":r(e))&&e.RTCPeerConnection&&e.RTCRtpSender&&(e.RTCRtpSender&&"getStats"in e.RTCRtpSender.prototype||((t=e.RTCPeerConnection.prototype.getSenders)&&(e.RTCPeerConnection.prototype.getSenders=function(){var e=this,n=t.apply(this,[]);return n.forEach((function(t){return t._pc=e})),n}),(n=e.RTCPeerConnection.prototype.addTrack)&&(e.RTCPeerConnection.prototype.addTrack=function(){var e=n.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Promise.resolve(new Map)}))},n.shimReceiverGetStats=function(e){var t;"object"===(void 0===e?"undefined":r(e))&&e.RTCPeerConnection&&e.RTCRtpSender&&(e.RTCRtpSender&&"getStats"in e.RTCRtpReceiver.prototype||((t=e.RTCPeerConnection.prototype.getReceivers)&&(e.RTCPeerConnection.prototype.getReceivers=function(){var e=this,n=t.apply(this,[]);return n.forEach((function(t){return t._pc=e})),n}),a.wrapPeerConnectionEvent(e,"track",(function(e){return e.receiver._pc=e.srcElement,e})),e.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}))},n.shimRemoveStream=function(e){!e.RTCPeerConnection||"removeStream"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.removeStream=function(e){var t=this;a.deprecated("removeStream","removeTrack"),this.getSenders().forEach((function(n){n.track&&e.getTracks().includes(n.track)&&t.removeTrack(n)}))})},n.shimRTCDataChannel=function(e){e.DataChannel&&!e.RTCDataChannel&&(e.RTCDataChannel=e.DataChannel)},n.shimAddTransceiver=function(e){var t;"object"!==(void 0===e?"undefined":r(e))||!e.RTCPeerConnection||(t=e.RTCPeerConnection.prototype.addTransceiver)&&(e.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];var e=arguments[1],n=e&&"sendEncodings"in e;n&&e.sendEncodings.forEach((function(e){if("rid"in e&&!/^[a-z0-9]{0,16}$/i.test(e.rid))throw new TypeError("Invalid RID value provided.");if("scaleResolutionDownBy"in e&&!(1<=parseFloat(e.scaleResolutionDownBy)))throw new RangeError("scale_resolution_down_by must be >= 1.0");if("maxFramerate"in e&&!(0<=parseFloat(e.maxFramerate)))throw new RangeError("max_framerate must be >= 0.0")}));var r,o=t.apply(this,arguments);return n&&("encodings"in(n=(r=o.sender).getParameters())&&(1!==n.encodings.length||0!==Object.keys(n.encodings[0]).length)||(n.encodings=e.sendEncodings,r.sendEncodings=e.sendEncodings,this.setParametersPromises.push(r.setParameters(n).then((function(){delete r.sendEncodings})).catch((function(){delete r.sendEncodings}))))),o})},n.shimGetParameters=function(e){var t;"object"!==(void 0===e?"undefined":r(e))||!e.RTCRtpSender||(t=e.RTCRtpSender.prototype.getParameters)&&(e.RTCRtpSender.prototype.getParameters=function(){var e=t.apply(this,arguments);return"encodings"in e||(e.encodings=[].concat(this.sendEncodings||[{}])),e})},n.shimCreateOffer=function(e){var t;"object"===(void 0===e?"undefined":r(e))&&e.RTCPeerConnection&&(t=e.RTCPeerConnection.prototype.createOffer,e.RTCPeerConnection.prototype.createOffer=function(){var e=this,n=arguments;return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then((function(){return t.apply(e,n)})).finally((function(){e.setParametersPromises=[]})):t.apply(this,arguments)})},n.shimCreateAnswer=function(e){var t;"object"===(void 0===e?"undefined":r(e))&&e.RTCPeerConnection&&(t=e.RTCPeerConnection.prototype.createAnswer,e.RTCPeerConnection.prototype.createAnswer=function(){var e=this,n=arguments;return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then((function(){return t.apply(e,n)})).finally((function(){e.setParametersPromises=[]})):t.apply(this,arguments)})};var a=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}(e("../utils"))},{"../utils":11,"./getdisplaymedia":8,"./getusermedia":9}],8:[function(e,t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.shimGetDisplayMedia=function(e,t){e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||e.navigator.mediaDevices&&(e.navigator.mediaDevices.getDisplayMedia=function(n){return n&&n.video?(!0===n.video?n.video={mediaSource:t}:n.video.mediaSource=t,e.navigator.mediaDevices.getUserMedia(n)):((n=new DOMException("getDisplayMedia without video constraints is undefined")).name="NotFoundError",n.code=8,Promise.reject(n))})}},{}],9:[function(e,t,n){Object.defineProperty(n,"__esModule",{value:!0});var r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};n.shimGetUserMedia=function(e,t){var n,i,a,s,c=e&&e.navigator;e=e&&e.MediaStreamTrack;c.getUserMedia=function(e,t,n){o.deprecated("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),c.mediaDevices.getUserMedia(e).then(t,n)},55<t.version&&"autoGainControl"in c.mediaDevices.getSupportedConstraints()||(n=function(e,t,n){t in e&&!(n in e)&&(e[n]=e[t],delete e[t])},i=c.mediaDevices.getUserMedia.bind(c.mediaDevices),c.mediaDevices.getUserMedia=function(e){return"object"===(void 0===e?"undefined":r(e))&&"object"===r(e.audio)&&(e=JSON.parse(JSON.stringify(e)),n(e.audio,"autoGainControl","mozAutoGainControl"),n(e.audio,"noiseSuppression","mozNoiseSuppression")),i(e)},e&&e.prototype.getSettings&&(a=e.prototype.getSettings,e.prototype.getSettings=function(){var e=a.apply(this,arguments);return n(e,"mozAutoGainControl","autoGainControl"),n(e,"mozNoiseSuppression","noiseSuppression"),e}),e&&e.prototype.applyConstraints&&(s=e.prototype.applyConstraints,e.prototype.applyConstraints=function(e){return"audio"===this.kind&&"object"===(void 0===e?"undefined":r(e))&&(e=JSON.parse(JSON.stringify(e)),n(e,"autoGainControl","mozAutoGainControl"),n(e,"noiseSuppression","mozNoiseSuppression")),s.apply(this,[e])}))};var o=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}(e("../utils"))},{"../utils":11}],10:[function(e,t,n){Object.defineProperty(n,"__esModule",{value:!0});var r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};n.shimLocalStreamsAPI=function(e){var t;"object"===(void 0===e?"undefined":r(e))&&e.RTCPeerConnection&&("getLocalStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),"addStream"in e.RTCPeerConnection.prototype||(t=e.RTCPeerConnection.prototype.addTrack,e.RTCPeerConnection.prototype.addStream=function(e){var n=this;this._localStreams||(this._localStreams=[]),this._localStreams.includes(e)||this._localStreams.push(e),e.getAudioTracks().forEach((function(r){return t.call(n,r,e)})),e.getVideoTracks().forEach((function(r){return t.call(n,r,e)}))},e.RTCPeerConnection.prototype.addTrack=function(e){for(var n=this,r=arguments.length,o=Array(1<r?r-1:0),i=1;i<r;i++)o[i-1]=arguments[i];return o&&o.forEach((function(e){n._localStreams?n._localStreams.includes(e)||n._localStreams.push(e):n._localStreams=[e]})),t.apply(this,arguments)}),"removeStream"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.removeStream=function(e){var t=this;this._localStreams||(this._localStreams=[]);var n,r=this._localStreams.indexOf(e);-1!==r&&(this._localStreams.splice(r,1),n=e.getTracks(),this.getSenders().forEach((function(e){n.includes(e.track)&&t.removeTrack(e)})))}))},n.shimRemoteStreamsAPI=function(e){var t;"object"===(void 0===e?"undefined":r(e))&&e.RTCPeerConnection&&("getRemoteStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams||[]}),"onaddstream"in e.RTCPeerConnection.prototype||(Object.defineProperty(e.RTCPeerConnection.prototype,"onaddstream",{get:function(){return this._onaddstream},set:function(e){var t=this;this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=e),this.addEventListener("track",this._onaddstreampoly=function(e){e.streams.forEach((function(e){var n;t._remoteStreams||(t._remoteStreams=[]),t._remoteStreams.includes(e)||(t._remoteStreams.push(e),(n=new Event("addstream")).stream=e,t.dispatchEvent(n))}))})}}),t=e.RTCPeerConnection.prototype.setRemoteDescription,e.RTCPeerConnection.prototype.setRemoteDescription=function(){var e=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(t){t.streams.forEach((function(t){var n;e._remoteStreams||(e._remoteStreams=[]),0<=e._remoteStreams.indexOf(t)||(e._remoteStreams.push(t),(n=new Event("addstream")).stream=t,e.dispatchEvent(n))}))}),t.apply(e,arguments)}))},n.shimCallbacksAPI=function(e){var t,n,o,i,a,s;"object"===(void 0===e?"undefined":r(e))&&e.RTCPeerConnection&&(t=e.RTCPeerConnection.prototype,n=t.createOffer,o=t.createAnswer,i=t.setLocalDescription,a=t.setRemoteDescription,s=t.addIceCandidate,t.createOffer=function(e,t){var r=n.apply(this,[2<=arguments.length?arguments[2]:e]);return t?(r.then(e,t),Promise.resolve()):r},t.createAnswer=function(e,t){var n=o.apply(this,[2<=arguments.length?arguments[2]:e]);return t?(n.then(e,t),Promise.resolve()):n},e=function(e,t,n){return e=i.apply(this,[e]),n?(e.then(t,n),Promise.resolve()):e},t.setLocalDescription=e,e=function(e,t,n){return e=a.apply(this,[e]),n?(e.then(t,n),Promise.resolve()):e},t.setRemoteDescription=e,e=function(e,t,n){return e=s.apply(this,[e]),n?(e.then(t,n),Promise.resolve()):e},t.addIceCandidate=e)},n.shimGetUserMedia=function(e){var t,n=e&&e.navigator;n.mediaDevices&&n.mediaDevices.getUserMedia&&(e=n.mediaDevices,t=e.getUserMedia.bind(e),n.mediaDevices.getUserMedia=function(e){return t(i(e))}),!n.getUserMedia&&n.mediaDevices&&n.mediaDevices.getUserMedia&&(n.getUserMedia=function(e,t,r){n.mediaDevices.getUserMedia(e).then(t,r)}.bind(n))},n.shimConstraints=i,n.shimRTCIceServerUrls=function(e){var t;e.RTCPeerConnection&&(t=e.RTCPeerConnection,e.RTCPeerConnection=function(e,n){if(e&&e.iceServers){for(var r=[],i=0;i<e.iceServers.length;i++){var a=e.iceServers[i];!a.hasOwnProperty("urls")&&a.hasOwnProperty("url")?(o.deprecated("RTCIceServer.url","RTCIceServer.urls"),(a=JSON.parse(JSON.stringify(a))).urls=a.url,delete a.url,r.push(a)):r.push(e.iceServers[i])}e.iceServers=r}return new t(e,n)},e.RTCPeerConnection.prototype=t.prototype,"generateCertificate"in t&&Object.defineProperty(e.RTCPeerConnection,"generateCertificate",{get:function(){return t.generateCertificate}}))},n.shimTrackEventTransceiver=function(e){"object"===(void 0===e?"undefined":r(e))&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get:function(){return{receiver:this.receiver}}})},n.shimCreateOfferLegacy=function(e){var t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(e){var n;return e&&(void 0!==e.offerToReceiveAudio&&(e.offerToReceiveAudio=!!e.offerToReceiveAudio),n=this.getTransceivers().find((function(e){return"audio"===e.receiver.track.kind})),!1===e.offerToReceiveAudio&&n?"sendrecv"===n.direction?n.setDirection?n.setDirection("sendonly"):n.direction="sendonly":"recvonly"===n.direction&&(n.setDirection?n.setDirection("inactive"):n.direction="inactive"):!0!==e.offerToReceiveAudio||n||this.addTransceiver("audio",{direction:"recvonly"}),void 0!==e.offerToReceiveVideo&&(e.offerToReceiveVideo=!!e.offerToReceiveVideo),n=this.getTransceivers().find((function(e){return"video"===e.receiver.track.kind})),!1===e.offerToReceiveVideo&&n?"sendrecv"===n.direction?n.setDirection?n.setDirection("sendonly"):n.direction="sendonly":"recvonly"===n.direction&&(n.setDirection?n.setDirection("inactive"):n.direction="inactive"):!0!==e.offerToReceiveVideo||n||this.addTransceiver("video",{direction:"recvonly"})),t.apply(this,arguments)}},n.shimAudioContext=function(e){"object"!==(void 0===e?"undefined":r(e))||e.AudioContext||(e.AudioContext=e.webkitAudioContext)};var o=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}(e("../utils"));function i(e){return e&&void 0!==e.video?Object.assign({},e,{video:o.compactObject(e.video)}):e}},{"../utils":11}],11:[function(e,t,n){Object.defineProperty(n,"__esModule",{value:!0});var r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};n.extractVersion=a,n.wrapPeerConnectionEvent=function(e,t,n){var r,o;e.RTCPeerConnection&&(e=e.RTCPeerConnection.prototype,r=e.addEventListener,e.addEventListener=function(e,o){if(e!==t)return r.apply(this,arguments);function i(e){(e=n(e))&&(o.handleEvent?o.handleEvent(e):o(e))}return this._eventMap=this._eventMap||{},this._eventMap[t]||(this._eventMap[t]=new Map),this._eventMap[t].set(o,i),r.apply(this,[e,i])},o=e.removeEventListener,e.removeEventListener=function(e,n){if(e!==t||!this._eventMap||!this._eventMap[t])return o.apply(this,arguments);if(!this._eventMap[t].has(n))return o.apply(this,arguments);var r=this._eventMap[t].get(n);return this._eventMap[t].delete(n),0===this._eventMap[t].size&&delete this._eventMap[t],0===Object.keys(this._eventMap).length&&delete this._eventMap,o.apply(this,[e,r])},Object.defineProperty(e,"on"+t,{get:function(){return this["_on"+t]},set:function(e){this["_on"+t]&&(this.removeEventListener(t,this["_on"+t]),delete this["_on"+t]),e&&this.addEventListener(t,this["_on"+t]=e)},enumerable:!0,configurable:!0}))},n.disableLog=function(e){return"boolean"==typeof e?(o=e)?"adapter.js logging disabled":"adapter.js logging enabled":new Error("Argument type: "+(void 0===e?"undefined":r(e))+". Please use a boolean.")},n.disableWarnings=function(e){return"boolean"==typeof e?(i=!e,"adapter.js deprecation warnings "+(e?"disabled":"enabled")):new Error("Argument type: "+(void 0===e?"undefined":r(e))+". Please use a boolean.")},n.log=function(){"object"===("undefined"==typeof window?"undefined":r(window))&&(o||"undefined"!=typeof console&&"function"==typeof console.log&&console.log.apply(console,arguments))},n.deprecated=function(e,t){i&&console.warn(e+" is deprecated, please use "+t+" instead.")},n.detectBrowser=function(e){var t={browser:null,version:null};if(void 0===e||!e.navigator)return t.browser="Not a browser.",t;var n=e.navigator;if(n.mozGetUserMedia)t.browser="firefox",t.version=a(n.userAgent,/Firefox\/(\d+)\./,1);else if(n.webkitGetUserMedia||!1===e.isSecureContext&&e.webkitRTCPeerConnection&&!e.RTCIceGatherer)t.browser="chrome",t.version=a(n.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else{if(!e.RTCPeerConnection||!n.userAgent.match(/AppleWebKit\/(\d+)\./))return t.browser="Not a supported browser.",t;t.browser="safari",t.version=a(n.userAgent,/AppleWebKit\/(\d+)\./,1),t.supportsUnifiedPlan=e.RTCRtpTransceiver&&"currentDirection"in e.RTCRtpTransceiver.prototype}return t},n.compactObject=function e(t){return s(t)?Object.keys(t).reduce((function(n,r){var o=(i=s(t[r]))?e(t[r]):t[r],i=i&&!Object.keys(o).length;return void 0===o||i?n:Object.assign(n,function(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}({},r,o))}),{}):t},n.walkStats=c,n.filterStats=function(e,t,n){var r=n?"outbound-rtp":"inbound-rtp",o=new Map;if(null===t)return o;var i=[];return e.forEach((function(e){"track"===e.type&&e.trackIdentifier===t.id&&i.push(e)})),i.forEach((function(t){e.forEach((function(n){n.type===r&&n.trackId===t.id&&c(e,n,o)}))})),o};var o=!0,i=!0;function a(e,t,n){return(t=e.match(t))&&t.length>=n&&parseInt(t[n],10)}function s(e){return"[object Object]"===Object.prototype.toString.call(e)}function c(e,t,n){t&&!n.has(t.id)&&(n.set(t.id,t),Object.keys(t).forEach((function(r){r.endsWith("Id")?c(e,e.get(t[r]),n):r.endsWith("Ids")&&t[r].forEach((function(t){c(e,e.get(t),n)}))})))}},{}],12:[function(e,t,n){var r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},o={generateIdentifier:function(){return Math.random().toString(36).substr(2,10)}};o.localCName=o.generateIdentifier(),o.splitLines=function(e){return e.trim().split("\n").map((function(e){return e.trim()}))},o.splitSections=function(e){return e.split("\nm=").map((function(e,t){return(0<t?"m="+e:e).trim()+"\r\n"}))},o.getDescription=function(e){return(e=o.splitSections(e))&&e[0]},o.getMediaSections=function(e){return(e=o.splitSections(e)).shift(),e},o.matchPrefix=function(e,t){return o.splitLines(e).filter((function(e){return 0===e.indexOf(t)}))},o.parseCandidate=function(e){for(var t=void 0,n={foundation:(t=(0===e.indexOf("a=candidate:")?e.substring(12):e.substring(10)).split(" "))[0],component:{1:"rtp",2:"rtcp"}[t[1]]||t[1],protocol:t[2].toLowerCase(),priority:parseInt(t[3],10),ip:t[4],address:t[4],port:parseInt(t[5],10),type:t[7]},r=8;r<t.length;r+=2)switch(t[r]){case"raddr":n.relatedAddress=t[r+1];break;case"rport":n.relatedPort=parseInt(t[r+1],10);break;case"tcptype":n.tcpType=t[r+1];break;case"ufrag":n.ufrag=t[r+1],n.usernameFragment=t[r+1];break;default:void 0===n[t[r]]&&(n[t[r]]=t[r+1])}return n},o.writeCandidate=function(e){var t=[];t.push(e.foundation);var n=e.component;return"rtp"===n?t.push(1):"rtcp"===n?t.push(2):t.push(n),t.push(e.protocol.toUpperCase()),t.push(e.priority),t.push(e.address||e.ip),t.push(e.port),n=e.type,t.push("typ"),t.push(n),"host"!==n&&e.relatedAddress&&e.relatedPort&&(t.push("raddr"),t.push(e.relatedAddress),t.push("rport"),t.push(e.relatedPort)),e.tcpType&&"tcp"===e.protocol.toLowerCase()&&(t.push("tcptype"),t.push(e.tcpType)),(e.usernameFragment||e.ufrag)&&(t.push("ufrag"),t.push(e.usernameFragment||e.ufrag)),"candidate:"+t.join(" ")},o.parseIceOptions=function(e){return e.substr(14).split(" ")},o.parseRtpMap=function(e){var t=e.substr(9).split(" ");e={payloadType:parseInt(t.shift(),10)},t=t[0].split("/");return e.name=t[0],e.clockRate=parseInt(t[1],10),e.channels=3===t.length?parseInt(t[2],10):1,e.numChannels=e.channels,e},o.writeRtpMap=function(e){var t=e.payloadType;void 0!==e.preferredPayloadType&&(t=e.preferredPayloadType);var n=e.channels||e.numChannels||1;return"a=rtpmap:"+t+" "+e.name+"/"+e.clockRate+(1!==n?"/"+n:"")+"\r\n"},o.parseExtmap=function(e){return e=e.substr(9).split(" "),{id:parseInt(e[0],10),direction:0<e[0].indexOf("/")?e[0].split("/")[1]:"sendrecv",uri:e[1]}},o.writeExtmap=function(e){return"a=extmap:"+(e.id||e.preferredId)+(e.direction&&"sendrecv"!==e.direction?"/"+e.direction:"")+" "+e.uri+"\r\n"},o.parseFmtp=function(e){for(var t={},n=void 0,r=e.substr(e.indexOf(" ")+1).split(";"),o=0;o<r.length;o++)t[(n=r[o].trim().split("="))[0].trim()]=n[1];return t},o.writeFmtp=function(e){var t,n="",r=e.payloadType;return void 0!==e.preferredPayloadType&&(r=e.preferredPayloadType),e.parameters&&Object.keys(e.parameters).length&&(t=[],Object.keys(e.parameters).forEach((function(n){void 0!==e.parameters[n]?t.push(n+"="+e.parameters[n]):t.push(n)})),n+="a=fmtp:"+r+" "+t.join(";")+"\r\n"),n},o.parseRtcpFb=function(e){return{type:(e=e.substr(e.indexOf(" ")+1).split(" ")).shift(),parameter:e.join(" ")}},o.writeRtcpFb=function(e){var t="",n=e.payloadType;return void 0!==e.preferredPayloadType&&(n=e.preferredPayloadType),e.rtcpFeedback&&e.rtcpFeedback.length&&e.rtcpFeedback.forEach((function(e){t+="a=rtcp-fb:"+n+" "+e.type+(e.parameter&&e.parameter.length?" "+e.parameter:"")+"\r\n"})),t},o.parseSsrcMedia=function(e){var t=e.indexOf(" "),n={ssrc:parseInt(e.substr(7,t-7),10)},r=e.indexOf(":",t);return-1<r?(n.attribute=e.substr(t+1,r-t-1),n.value=e.substr(r+1)):n.attribute=e.substr(t+1),n},o.parseSsrcGroup=function(e){return{semantics:(e=e.substr(13).split(" ")).shift(),ssrcs:e.map((function(e){return parseInt(e,10)}))}},o.getMid=function(e){if(e=o.matchPrefix(e,"a=mid:")[0])return e.substr(6)},o.parseFingerprint=function(e){return{algorithm:(e=e.substr(14).split(" "))[0].toLowerCase(),value:e[1].toUpperCase()}},o.getDtlsParameters=function(e,t){return{role:"auto",fingerprints:o.matchPrefix(e+t,"a=fingerprint:").map(o.parseFingerprint)}},o.writeDtlsParameters=function(e,t){var n="a=setup:"+t+"\r\n";return e.fingerprints.forEach((function(e){n+="a=fingerprint:"+e.algorithm+" "+e.value+"\r\n"})),n},o.parseCryptoLine=function(e){return e=e.substr(9).split(" "),{tag:parseInt(e[0],10),cryptoSuite:e[1],keyParams:e[2],sessionParams:e.slice(3)}},o.writeCryptoLine=function(e){return"a=crypto:"+e.tag+" "+e.cryptoSuite+" "+("object"===r(e.keyParams)?o.writeCryptoKeyParams(e.keyParams):e.keyParams)+(e.sessionParams?" "+e.sessionParams.join(" "):"")+"\r\n"},o.parseCryptoKeyParams=function(e){return 0!==e.indexOf("inline:")?null:{keyMethod:"inline",keySalt:(e=e.substr(7).split("|"))[0],lifeTime:e[1],mkiValue:e[2]?e[2].split(":")[0]:void 0,mkiLength:e[2]?e[2].split(":")[1]:void 0}},o.writeCryptoKeyParams=function(e){return e.keyMethod+":"+e.keySalt+(e.lifeTime?"|"+e.lifeTime:"")+(e.mkiValue&&e.mkiLength?"|"+e.mkiValue+":"+e.mkiLength:"")},o.getCryptoParameters=function(e,t){return o.matchPrefix(e+t,"a=crypto:").map(o.parseCryptoLine)},o.getIceParameters=function(e,t){var n=o.matchPrefix(e+t,"a=ice-ufrag:")[0];t=o.matchPrefix(e+t,"a=ice-pwd:")[0];return n&&t?{usernameFragment:n.substr(12),password:t.substr(10)}:null},o.writeIceParameters=function(e){var t="a=ice-ufrag:"+e.usernameFragment+"\r\na=ice-pwd:"+e.password+"\r\n";return e.iceLite&&(t+="a=ice-lite\r\n"),t},o.parseRtpParameters=function(e){for(var t={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},n=o.splitLines(e)[0].split(" "),r=3;r<n.length;r++){var i=n[r];if(s=o.matchPrefix(e,"a=rtpmap:"+i+" ")[0]){var a=o.parseRtpMap(s),s=o.matchPrefix(e,"a=fmtp:"+i+" ");switch(a.parameters=s.length?o.parseFmtp(s[0]):{},a.rtcpFeedback=o.matchPrefix(e,"a=rtcp-fb:"+i+" ").map(o.parseRtcpFb),t.codecs.push(a),a.name.toUpperCase()){case"RED":case"ULPFEC":t.fecMechanisms.push(a.name.toUpperCase())}}}return o.matchPrefix(e,"a=extmap:").forEach((function(e){t.headerExtensions.push(o.parseExtmap(e))})),t},o.writeRtpDescription=function(e,t){var n="";n+="m="+e+" ",n+=0<t.codecs.length?"9":"0",n+=" UDP/TLS/RTP/SAVPF ",n+=t.codecs.map((function(e){return void 0!==e.preferredPayloadType?e.preferredPayloadType:e.payloadType})).join(" ")+"\r\n",n+="c=IN IP4 0.0.0.0\r\n",n+="a=rtcp:9 IN IP4 0.0.0.0\r\n",t.codecs.forEach((function(e){n+=o.writeRtpMap(e),n+=o.writeFmtp(e),n+=o.writeRtcpFb(e)}));var r=0;return t.codecs.forEach((function(e){e.maxptime>r&&(r=e.maxptime)})),0<r&&(n+="a=maxptime:"+r+"\r\n"),t.headerExtensions&&t.headerExtensions.forEach((function(e){n+=o.writeExtmap(e)})),n},o.parseRtpEncodingParameters=function(e){var t=[],n=o.parseRtpParameters(e),r=-1!==n.fecMechanisms.indexOf("RED"),i=-1!==n.fecMechanisms.indexOf("ULPFEC"),a=0<(c=o.matchPrefix(e,"a=ssrc:").map((function(e){return o.parseSsrcMedia(e)})).filter((function(e){return"cname"===e.attribute}))).length&&c[0].ssrc,s=void 0,c=o.matchPrefix(e,"a=ssrc-group:FID").map((function(e){return e.substr(17).split(" ").map((function(e){return parseInt(e,10)}))}));0<c.length&&1<c[0].length&&c[0][0]===a&&(s=c[0][1]),n.codecs.forEach((function(e){"RTX"===e.name.toUpperCase()&&e.parameters.apt&&(e={ssrc:a,codecPayloadType:parseInt(e.parameters.apt,10)},a&&s&&(e.rtx={ssrc:s}),t.push(e),r&&((e=JSON.parse(JSON.stringify(e))).fec={ssrc:a,mechanism:i?"red+ulpfec":"red"},t.push(e)))})),0===t.length&&a&&t.push({ssrc:a});var d=o.matchPrefix(e,"b=");return d.length&&(d=0===d[0].indexOf("b=TIAS:")?parseInt(d[0].substr(7),10):0===d[0].indexOf("b=AS:")?1e3*parseInt(d[0].substr(5),10)*.95-16e3:void 0,t.forEach((function(e){e.maxBitrate=d}))),t},o.parseRtcpParameters=function(e){var t={},n=o.matchPrefix(e,"a=ssrc:").map((function(e){return o.parseSsrcMedia(e)})).filter((function(e){return"cname"===e.attribute}))[0];return n&&(t.cname=n.value,t.ssrc=n.ssrc),n=o.matchPrefix(e,"a=rtcp-rsize"),t.reducedSize=0<n.length,t.compound=0===n.length,e=o.matchPrefix(e,"a=rtcp-mux"),t.mux=0<e.length,t},o.writeRtcpParameters=function(e){var t="";return e.reducedSize&&(t+="a=rtcp-rsize\r\n"),e.mux&&(t+="a=rtcp-mux\r\n"),void 0!==e.ssrc&&e.cname&&(t+="a=ssrc:"+e.ssrc+" cname:"+e.cname+"\r\n"),t},o.parseMsid=function(e){var t=void 0,n=o.matchPrefix(e,"a=msid:");return 1===n.length?{stream:(t=n[0].substr(7).split(" "))[0],track:t[1]}:0<(e=o.matchPrefix(e,"a=ssrc:").map((function(e){return o.parseSsrcMedia(e)})).filter((function(e){return"msid"===e.attribute}))).length?{stream:(t=e[0].value.split(" "))[0],track:t[1]}:void 0},o.parseSctpDescription=function(e){var t=o.parseMLine(e),n=o.matchPrefix(e,"a=max-message-size:"),r=void 0;return 0<n.length&&(r=parseInt(n[0].substr(19),10)),isNaN(r)&&(r=65536),0<(n=o.matchPrefix(e,"a=sctp-port:")).length?{port:parseInt(n[0].substr(12),10),protocol:t.fmt,maxMessageSize:r}:0<(e=o.matchPrefix(e,"a=sctpmap:")).length?(e=e[0].substr(10).split(" "),{port:parseInt(e[0],10),protocol:e[1],maxMessageSize:r}):void 0},o.writeSctpDescription=function(e,t){var n=[];n="DTLS/SCTP"!==e.protocol?["m="+e.kind+" 9 "+e.protocol+" "+t.protocol+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctp-port:"+t.port+"\r\n"]:["m="+e.kind+" 9 "+e.protocol+" "+t.port+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctpmap:"+t.port+" "+t.protocol+" 65535\r\n"];return void 0!==t.maxMessageSize&&n.push("a=max-message-size:"+t.maxMessageSize+"\r\n"),n.join("")},o.generateSessionId=function(){return Math.random().toString().substr(2,21)},o.writeSessionBoilerplate=function(e,t,n){return t=void 0!==t?t:2,"v=0\r\no="+(n||"thisisadapterortc")+" "+(e||o.generateSessionId())+" "+t+" IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n"},o.getDirection=function(e,t){for(var n=o.splitLines(e),r=0;r<n.length;r++)switch(n[r]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return n[r].substr(2)}return t?o.getDirection(t):"sendrecv"},o.getKind=function(e){return o.splitLines(e)[0].split(" ")[0].substr(2)},o.isRejected=function(e){return"0"===e.split(" ",2)[1]},o.parseMLine=function(e){return{kind:(e=o.splitLines(e)[0].substr(2).split(" "))[0],port:parseInt(e[1],10),protocol:e[2],fmt:e.slice(3).join(" ")}},o.parseOLine=function(e){return{username:(e=o.matchPrefix(e,"o=")[0].substr(2).split(" "))[0],sessionId:e[1],sessionVersion:parseInt(e[2],10),netType:e[3],addressType:e[4],address:e[5]}},o.isValidSDP=function(e){if("string"!=typeof e||0===e.length)return!1;for(var t=o.splitLines(e),n=0;n<t.length;n++)if(t[n].length<2||"="!==t[n].charAt(1))return!1;return!0},"object"===(void 0===t?"undefined":r(t))&&(t.exports=o)},{}]},{},[1])(1)})),t.sessions={},t.isExtensionEnabled=function(){if(navigator.mediaDevices&&navigator.mediaDevices.getDisplayMedia)return!0;if(window.navigator.userAgent.match("Chrome")){let e=parseInt(window.navigator.userAgent.match(/Chrome\/(.*) /)[1],10),n=33;return window.navigator.userAgent.match("Linux")&&(n=35),e>=26&&e<=n||t.extension.isInstalled()}return!0};var e={extensionId:"hapfgfdkleiggjjpfpenajgdnfckjpaj",isInstalled:function(){return null!==document.querySelector("#janus-extension-installed")},getScreen:function(e){let t=window.setTimeout((function(){let t=new Error("NavigatorUserMediaError");return t.name='The required Chrome extension is not installed: click <a href="#">here</a> to install it. (NOTE: this will need you to refresh the page)',e(t)}),1e3);this.cache[t]=e,window.postMessage({type:"janusGetScreen",id:t},"*")},init:function(){let e={};this.cache=e,window.addEventListener("message",(function(t){if(t.origin==window.location.origin)if("janusGotScreen"==t.data.type&&e[t.data.id]){let n=e[t.data.id];if(delete e[t.data.id],""===t.data.sourceId){let e=new Error("NavigatorUserMediaError");e.name="You cancelled the request for permission, giving up...",n(e)}else n(null,t.data.sourceId)}else"janusGetScreenPending"==t.data.type&&(console.log("clearing ",t.data.id),window.clearTimeout(t.data.id))}))}};function t(e){if((e=e||{}).success="function"==typeof e.success?e.success:t.noop,e.error="function"==typeof e.error?e.error:t.noop,e.destroyed="function"==typeof e.destroyed?e.destroyed:t.noop,!t.initDone)return e.error("Library not initialized"),{};if(!t.isWebrtcSupported())return e.error("WebRTC not supported by this browser"),{};if(t.log("Library initialized: "+t.initDone),!e.server)return e.error("Invalid server url"),{};let n=!1,r=null,o={},i=null,a=null,s=0,c=e.server;t.isArray(c)?(t.log("Multiple servers provided ("+c.length+"), will use the first that works"),c=null,a=e.server,t.debug(a)):0===c.indexOf("ws")?(n=!0,t.log("Using WebSockets to contact Janus: "+c)):(n=!1,t.log("Using REST API to contact Janus: "+c));let d=e.iceServers||[{urls:"stun:stun.l.google.com:19302"}],l=e.iceTransportPolicy,u=e.bundlePolicy,p=!1;void 0!==e.withCredentials&&null!==e.withCredentials&&(p=!0===e.withCredentials);let f=10;void 0!==e.max_poll_events&&null!==e.max_poll_events&&(f=e.max_poll_events),f<1&&(f=1);let m=null;void 0!==e.token&&null!==e.token&&(m=e.token);let h=null;void 0!==e.apisecret&&null!==e.apisecret&&(h=e.apisecret),this.destroyOnUnload=!0,void 0!==e.destroyOnUnload&&null!==e.destroyOnUnload&&(this.destroyOnUnload=!0===e.destroyOnUnload);let v=25e3;void 0!==e.keepAlivePeriod&&null!==e.keepAlivePeriod&&(v=e.keepAlivePeriod),isNaN(v)&&(v=25e3);let g=6e4;function y(e){let t={high:9e5,medium:3e5,low:1e5};return null!=e&&(e.high&&(t.high=e.high),e.medium&&(t.medium=e.medium),e.low&&(t.low=e.low)),t}void 0!==e.longPollTimeout&&null!==e.longPollTimeout&&(g=e.longPollTimeout),isNaN(g)&&(g=6e4);let b=!1,C=null,S={},w=this,T=0,k={};function R(){if(null==C)return;if(t.debug("Long poll..."),!b)return void t.warn("Is the server down? (connected=false)");let n=c+"/"+C+"?rid="+(new Date).getTime();f&&(n=n+"&maxev="+f),m&&(n=n+"&token="+encodeURIComponent(m)),h&&(n=n+"&apisecret="+encodeURIComponent(h)),t.httpAPICall(n,{verb:"GET",withCredentials:p,success:P,timeout:g,error:function(n,r){if(t.error(n+":",r),T++,T>3)return b=!1,void e.error("Lost connection to the server (is it down?)");R()}})}function P(e,o){if(T=0,n||null==C||!0===o||R(),n||!t.isArray(e))if("keepalive"!==e.janus)if("server_info"!==e.janus)if("ack"!==e.janus)if("success"!==e.janus)if("trickle"===e.janus){const n=e.sender;if(!n)return void t.warn("Missing sender...");const r=S[n];if(!r)return void t.debug("This handle is not attached to this session");let o=e.candidate;t.debug("Got a trickled candidate on session "+C),t.debug(o);let i=r.webrtcStuff;i.pc&&i.remoteSdp?(t.debug("Adding remote candidate:",o),o&&!0!==o.completed?i.pc.addIceCandidate(o):i.pc.addIceCandidate(t.endOfCandidates)):(t.debug("We didn't do setRemoteDescription (trickle got here before the offer?), caching candidate"),i.candidates||(i.candidates=[]),i.candidates.push(o),t.debug(i.candidates))}else{if("webrtcup"===e.janus){t.debug("Got a webrtcup event on session "+C),t.debug(e);const n=e.sender;if(!n)return void t.warn("Missing sender...");const r=S[n];return r?void r.webrtcState(!0):void t.debug("This handle is not attached to this session")}if("hangup"===e.janus){t.debug("Got a hangup event on session "+C),t.debug(e);const n=e.sender;if(!n)return void t.warn("Missing sender...");const r=S[n];if(!r)return void t.debug("This handle is not attached to this session");r.webrtcState(!1,e.reason),r.hangup()}else if("detached"===e.janus){t.debug("Got a detached event on session "+C),t.debug(e);const n=e.sender;if(!n)return void t.warn("Missing sender...");const r=S[n];if(!r)return;r.ondetached(),r.detach()}else if("media"===e.janus){t.debug("Got a media event on session "+C),t.debug(e);const n=e.sender;if(!n)return void t.warn("Missing sender...");const r=S[n];if(!r)return void t.debug("This handle is not attached to this session");r.mediaState(e.type,e.receiving,e.mid)}else if("slowlink"===e.janus){t.debug("Got a slowlink event on session "+C),t.debug(e);const n=e.sender;if(!n)return void t.warn("Missing sender...");const r=S[n];if(!r)return void t.debug("This handle is not attached to this session");r.slowLink(e.uplink,e.lost,e.mid)}else{if("error"===e.janus){t.error("Ooops: "+e.error.code+" "+e.error.reason),t.debug(e);let n=e.transaction;if(n){let t=k[n];t&&t(e),delete k[n]}return}if("event"===e.janus){t.debug("Got a plugin event on session "+C),t.debug(e);const n=e.sender;if(!n)return void t.warn("Missing sender...");let r=e.plugindata;if(!r)return void t.warn("Missing plugindata...");t.debug("  -- Event is coming from "+n+" ("+r.plugin+")");let o=r.data;t.debug(o);const i=S[n];if(!i)return void t.warn("This handle is not attached to this session");let a=e.jsep;a&&(t.debug("Handling SDP as well..."),t.debug(a));let s=i.onmessage;s?(t.debug("Notifying application..."),s(o,a)):t.debug("No provided notification callback")}else{if("timeout"===e.janus)return t.error("Timeout on session "+C),t.debug(e),void(n&&r.close(3504,"Gateway timeout"));t.warn("Unknown message/event  '"+e.janus+"' on session "+C),t.debug(e)}}}else{t.debug("Got a success on session "+C),t.debug(e);const n=e.transaction;if(n){const t=k[n];t&&t(e),delete k[n]}}else{t.debug("Got an ack on session "+C),t.debug(e);const n=e.transaction;if(n){const t=k[n];t&&t(e),delete k[n]}}else{t.debug("Got info on the Janus instance"),t.debug(e);const n=e.transaction;if(n){const t=k[n];t&&t(e),delete k[n]}}else t.vdebug("Got a keepalive on session "+C);else for(let t=0;t<e.length;t++)P(e[t],!0)}function E(){if(!c||!n||!b)return;i=setTimeout(E,v);let e={janus:"keepalive",session_id:C,transaction:t.randomString(12)};m&&(e.token=m),h&&(e.apisecret=h),r.send(JSON.stringify(e))}function I(d){let l=t.randomString(12),u={janus:"create",transaction:l};if(d.reconnect&&(b=!1,u.janus="claim",u.session_id=C,r&&(r.onopen=null,r.onerror=null,r.onclose=null,i&&(clearTimeout(i),i=null))),m&&(u.token=m),h&&(u.apisecret=h),!c&&t.isArray(a)&&(c=a[s],0===c.indexOf("ws")?(n=!0,t.log("Server #"+(s+1)+": trying WebSockets to contact Janus ("+c+")")):(n=!1,t.log("Server #"+(s+1)+": trying REST API to contact Janus ("+c+")"))),n){r=t.newWebSocket(c,"janus-protocol"),o={error:function(){if(t.error("Error connecting to the Janus WebSockets server... "+c),t.isArray(a)&&!d.reconnect)return s++,s===a.length?void d.error("Error connecting to any of the provided Janus servers: Is the server down?"):(c=null,void setTimeout((function(){I(d)}),200));d.error("Error connecting to the Janus WebSockets server: Is the server down?")},open:function(){k[l]=function(e){if(t.debug(e),"success"!==e.janus)return t.error("Ooops: "+e.error.code+" "+e.error.reason),void d.error(e.error.reason);i=setTimeout(E,v),b=!0,C=e.session_id?e.session_id:e.data.id,d.reconnect?t.log("Claimed session: "+C):t.log("Created session: "+C),t.sessions[C]=w,d.success()},r.send(JSON.stringify(u))},message:function(e){P(JSON.parse(e.data))},close:function(){c&&b&&(b=!1,e.error("Lost connection to the server (is it down?)"))}};for(let e in o)r.addEventListener(e,o[e])}else t.httpAPICall(c,{verb:"POST",withCredentials:p,body:u,success:function(e){if(t.debug(e),"success"!==e.janus)return t.error("Ooops: "+e.error.code+" "+e.error.reason),void d.error(e.error.reason);b=!0,C=e.session_id?e.session_id:e.data.id,d.reconnect?t.log("Claimed session: "+C):t.log("Created session: "+C),t.sessions[C]=w,R(),d.success()},error:function(e,n){if(t.error(e+":",n),t.isArray(a)&&!d.reconnect)return s++,s===a.length?void d.error("Error connecting to any of the provided Janus servers: Is the server down?"):(c=null,void setTimeout((function(){I(d)}),200));""===n?d.error(e+": Is the server down?"):n&&n.error?d.error(e+": "+n.error.message):d.error(e+": "+n)}})}function _(e,o){if((o=o||{}).success="function"==typeof o.success?o.success:t.noop,o.error="function"==typeof o.error?o.error:t.noop,!b)return t.warn("Is the server down? (connected=false)"),void o.error("Is the server down? (connected=false)");let i=S[e];if(!i||!i.webrtcStuff)return t.warn("Invalid handle"),void o.error("Invalid handle");let a=o.message,s=o.jsep,d=t.randomString(12),l={janus:"message",body:a,transaction:d};if(i.token&&(l.token=i.token),h&&(l.apisecret=h),s&&(l.jsep={type:s.type,sdp:s.sdp},s.e2ee&&(l.jsep.e2ee=!0),"hml"!==s.rid_order&&"lmh"!==s.rid_order||(l.jsep.rid_order=s.rid_order),s.force_relay&&(l.jsep.force_relay=!0)),t.debug("Sending message to plugin (handle="+e+"):"),t.debug(l),n)return l.session_id=C,l.handle_id=e,k[d]=function(e){if(t.debug("Message sent!"),t.debug(e),"success"===e.janus){let n=e.plugindata;if(!n)return t.warn("Request succeeded, but missing plugindata..."),void o.success();t.log("Synchronous transaction successful ("+n.plugin+")");let r=n.data;return t.debug(r),void o.success(r)}"ack"===e.janus?o.success():e.error?(t.error("Ooops: "+e.error.code+" "+e.error.reason),o.error(e.error.code+" "+e.error.reason)):(t.error("Unknown error"),o.error("Unknown error"))},void r.send(JSON.stringify(l));t.httpAPICall(c+"/"+C+"/"+e,{verb:"POST",withCredentials:p,body:l,success:function(e){if(t.debug("Message sent!"),t.debug(e),"success"===e.janus){let n=e.plugindata;if(!n)return t.warn("Request succeeded, but missing plugindata..."),void o.success();t.log("Synchronous transaction successful ("+n.plugin+")");let r=n.data;return t.debug(r),void o.success(r)}"ack"===e.janus?o.success():e.error?(t.error("Ooops: "+e.error.code+" "+e.error.reason),o.error(e.error.code+" "+e.error.reason)):(t.error("Unknown error"),o.error("Unknown error"))},error:function(e,n){t.error(e+":",n),o.error(e+": "+n)}})}function D(e,o){if(!b)return void t.warn("Is the server down? (connected=false)");let i=S[e];if(!i||!i.webrtcStuff)return void t.warn("Invalid handle");let a={janus:"trickle",candidate:o,transaction:t.randomString(12)};if(i.token&&(a.token=i.token),h&&(a.apisecret=h),t.vdebug("Sending trickle candidate (handle="+e+"):"),t.vdebug(a),n)return a.session_id=C,a.handle_id=e,void r.send(JSON.stringify(a));t.httpAPICall(c+"/"+C+"/"+e,{verb:"POST",withCredentials:p,body:a,success:function(e){t.vdebug("Candidate sent!"),t.vdebug(e),"ack"===e.janus||t.error("Ooops: "+e.error.code+" "+e.error.reason)},error:function(e,n){t.error(e+":",n)}})}function O(e,n,r,o,i){let a=S[e];if(!a||!a.webrtcStuff)return void t.warn("Invalid handle");let s=a.webrtcStuff;if(!s.pc)return void t.warn("Invalid PeerConnection");let c=function(e){t.log("Received state change on data channel:",e);let n=e.target.label,r=e.target.protocol,o=s.dataChannel[n]?s.dataChannel[n].readyState:"null";if(t.log("State change on <"+n+"> data channel: "+o),"open"===o){if(s.dataChannel[n].pending&&s.dataChannel[n].pending.length>0){t.log("Sending pending messages on <"+n+">:",s.dataChannel[n].pending.length);for(let e of s.dataChannel[n].pending)t.log("Sending data on data channel <"+n+">"),t.debug(e),s.dataChannel[n].send(e);s.dataChannel[n].pending=[]}a.ondataopen(n,r)}};if(o)s.dataChannel[n]=o;else{let e=s.dataChannelOptions;r&&(e.protocol=r),s.dataChannel[n]=s.pc.createDataChannel(n,e)}s.dataChannel[n].onmessage=function(e){t.log("Received message on data channel:",e);let n=e.target.label;a.ondata(e.data,n)},s.dataChannel[n].onopen=c,s.dataChannel[n].onclose=c,s.dataChannel[n].onerror=function(e){t.error("Got error on data channel:",e)},s.dataChannel[n].pending=[],i&&s.dataChannel[n].pending.push(i)}function M(e,n){(n=n||{}).success="function"==typeof n.success?n.success:t.noop,n.error="function"==typeof n.error?n.error:t.noop;let r=S[e];if(!r||!r.webrtcStuff)return t.warn("Invalid handle"),void n.error("Invalid handle");let o=r.webrtcStuff,i=n.text||n.data;if(!i)return t.warn("Invalid data"),void n.error("Invalid data");let a=n.label?n.label:t.dataChanDefaultLabel;return o.dataChannel[a]?"open"!==o.dataChannel[a].readyState?(o.dataChannel[a].pending.push(i),void n.success()):(t.log("Sending data on data channel <"+a+">"),t.debug(i),o.dataChannel[a].send(i),void n.success()):(O(e,a,n.protocol,!1,i,n.protocol),void n.success())}function x(e,n){(n=n||{}).success="function"==typeof n.success?n.success:t.noop,n.error="function"==typeof n.error?n.error:t.noop;let r=S[e];if(!r||!r.webrtcStuff)return t.warn("Invalid handle"),void n.error("Invalid handle");let o=r.webrtcStuff;if(!o.dtmfSender){if(o.pc){let e=o.pc.getSenders().find((function(e){return e.track&&"audio"===e.track.kind}));if(!e)return t.warn("Invalid DTMF configuration (no audio track)"),void n.error("Invalid DTMF configuration (no audio track)");o.dtmfSender=e.dtmf,o.dtmfSender&&(t.log("Created DTMF Sender"),o.dtmfSender.ontonechange=function(e){t.debug("Sent DTMF tone: "+e.tone)})}if(!o.dtmfSender)return t.warn("Invalid DTMF configuration"),void n.error("Invalid DTMF configuration")}let i=n.dtmf;if(!i)return t.warn("Invalid DTMF parameters"),void n.error("Invalid DTMF parameters");let a=i.tones;if(!a)return t.warn("Invalid DTMF string"),void n.error("Invalid DTMF string");let s="number"==typeof i.duration?i.duration:500,c="number"==typeof i.gap?i.gap:50;t.debug("Sending DTMF string "+a+" (duration "+s+"ms, gap "+c+"ms)"),o.dtmfSender.insertDTMF(a,s,c),n.success()}function A(e,o){(o=o||{}).success="function"==typeof o.success?o.success:t.noop,o.error="function"==typeof o.error?o.error:t.noop;let i=!0===o.noRequest;t.log("Destroying handle "+e+" (only-locally="+i+")"),H(e);let a=S[e];if(!a||a.detached)return delete S[e],void o.success();if(a.detached=!0,i)return delete S[e],void o.success();if(!b)return t.warn("Is the server down? (connected=false)"),void o.error("Is the server down? (connected=false)");let s={janus:"detach",transaction:t.randomString(12)};if(a.token&&(s.token=a.token),h&&(s.apisecret=h),n)return s.session_id=C,s.handle_id=e,r.send(JSON.stringify(s)),delete S[e],void o.success();t.httpAPICall(c+"/"+C+"/"+e,{verb:"POST",withCredentials:p,body:s,success:function(n){t.log("Destroyed handle:"),t.debug(n),"success"!==n.janus&&t.error("Ooops: "+n.error.code+" "+n.error.reason),delete S[e],o.success()},error:function(n,r){t.error(n+":",r),delete S[e],o.success()}})}function j(e,n){let r=S[e];if(!r||!r.webrtcStuff)throw t.warn("Invalid handle"),"Invalid handle";let o=r.webrtcStuff;if(o.pc)return;let i={iceServers:d,iceTransportPolicy:l,bundlePolicy:u,sdpSemantics:"unified-plan"},a=!1;if(n.tracks)for(let e of n.tracks)if(e.transforms&&(e.transforms.sender||e.transforms.receiver)){a=!0;break}RTCRtpSender&&(RTCRtpSender.prototype.createEncodedStreams||RTCRtpSender.prototype.createEncodedAudioStreams&&RTCRtpSender.prototype.createEncodedVideoStreams)&&a&&(o.insertableStreams=!0,i.forceEncodedAudioInsertableStreams=!0,i.forceEncodedVideoInsertableStreams=!0,i.encodedInsertableStreams=!0),t.log("Creating PeerConnection"),o.pc=new RTCPeerConnection(i),t.debug(o.pc),o.pc.getStats&&(o.volume={},o.bitrate.value="0 kbits/sec"),t.log("Preparing local SDP and gathering candidates (trickle="+o.trickle+")"),o.pc.oniceconnectionstatechange=function(){o.pc&&r.iceState(o.pc.iceConnectionState)},o.pc.onicecandidate=function(r){if(!r.candidate||r.candidate.candidate&&r.candidate.candidate.indexOf("endOfCandidates")>0)t.log("End of candidates."),o.iceDone=!0,!0===o.trickle?D(e,{completed:!0}):function(e,n){(n=n||{}).success="function"==typeof n.success?n.success:t.noop,n.error="function"==typeof n.error?n.error:t.noop;let r=S[e];if(!r||!r.webrtcStuff)return void t.warn("Invalid handle, not sending anything");let o=r.webrtcStuff;if(t.log("Sending offer/answer SDP..."),!o.mySdp)return void t.warn("Local SDP instance is invalid, not sending anything...");o.mySdp={type:o.pc.localDescription.type,sdp:o.pc.localDescription.sdp},!1===o.trickle&&(o.mySdp.trickle=!1);t.debug(n),o.sdpSent=!0,n.success(o.mySdp)}(e,n);else{let t={candidate:r.candidate.candidate,sdpMid:r.candidate.sdpMid,sdpMLineIndex:r.candidate.sdpMLineIndex};!0===o.trickle&&D(e,t)}},o.pc.ontrack=function(e){if(t.log("Handling Remote Track",e),!e.streams)return;if(!e.track)return;let n=e.transceiver?e.transceiver.mid:e.track.id;try{r.onremotetrack(e.track,n,!0)}catch(e){t.error(e)}if(e.track.onended)return;let i=null;t.log("Adding onended callback to track:",e.track),e.track.onended=function(e){t.log("Remote track removed:",e),clearTimeout(i);let n=o.pc.getTransceivers().find((t=>t.receiver.track===e.target)),a=n?n.mid:e.target.id;try{r.onremotetrack(e.target,a,!1)}catch(e){t.error(e)}},e.track.onmute=function(e){t.log("Remote track muted:",e),i||(i=setTimeout((function(){t.log("Removing remote track");let n=o.pc.getTransceivers().find((t=>t.receiver.track===e.target)),a=n?n.mid:e.target.id;try{r.onremotetrack(e.target,a,!1)}catch(e){t.error(e)}i=null}),2520))},e.track.onunmute=function(e){if(t.log("Remote track flowing again:",e),null!=i)clearTimeout(i),i=null;else try{let t=o.pc.getTransceivers().find((t=>t.receiver.track===e.target)),n=t?t.mid:e.target.id;r.onremotetrack(e.target,n,!0)}catch(e){t.error(e)}}}}async function L(e,n,r){(r=r||{}).success="function"==typeof r.success?r.success:t.noop,r.error="function"==typeof r.error?r.error:$;let o=r.jsep;if(n&&o)return t.error("Provided a JSEP to a createOffer"),void r.error("Provided a JSEP to a createOffer");if(!(n||o&&o.type&&o.sdp))return t.error("A valid JSEP is required for createAnswer"),void r.error("A valid JSEP is required for createAnswer");if(r.media&&!r.tracks){if(r.tracks=t.mediaToTracks(r.media),!0===r.simulcast||!0===r.simulcast2||r.svc)for(let e of r.tracks)if("video"===e.type){!0===r.simulcast||!0===r.simulcast2?e.simulcast=!0:r.svc&&(e.svc=r.svc);break}t.warn("Deprecated media object passed, use tracks instead. Automatically translated to:",r.tracks)}if(r.tracks&&!Array.isArray(r.tracks))return t.error("Tracks must be an array"),void r.error("Tracks must be an array");let i=S[e];if(!i||!i.webrtcStuff)return t.warn("Invalid handle"),void r.error("Invalid handle");let a=i.webrtcStuff;var s;a.trickle=(s=r.trickle,t.debug("isTrickleEnabled:",s),!1!==s);try{if(j(e,r),n&&await F(e,r),o){if(await a.pc.setRemoteDescription(o),t.log("Remote description accepted!"),a.remoteSdp=o.sdp,a.candidates&&a.candidates.length>0){for(let e=0;e<a.candidates.length;e++){let n=a.candidates[e];t.debug("Adding remote candidate:",n),n&&!0!==n.completed?a.pc.addIceCandidate(n):a.pc.addIceCandidate(t.endOfCandidates)}a.candidates=[]}await F(e,r);let n=await async function(e,n){(n=n||{}).customizeSdp="function"==typeof n.customizeSdp?n.customizeSdp:t.noop;let r=S[e];if(!r||!r.webrtcStuff)throw t.warn("Invalid handle"),"Invalid handle";let o=r.webrtcStuff;t.log("Creating answer (iceDone="+o.iceDone+")");let i=await o.pc.createAnswer();t.debug(i);let a={type:"answer",sdp:i.sdp};if(n.customizeSdp(a),i.sdp=a.sdp,t.log("Setting local description"),o.mySdp={type:"answer",sdp:i.sdp},await o.pc.setLocalDescription(i),!o.iceDone&&!o.trickle)return t.log("Waiting for all candidates..."),null;o.insertableStreams&&(i.e2ee=!0);return i}(e,r);r.success(n)}else{let n=await async function(e,n){(n=n||{}).customizeSdp="function"==typeof n.customizeSdp?n.customizeSdp:t.noop;let r=S[e];if(!r||!r.webrtcStuff)throw t.warn("Invalid handle"),"Invalid handle";let o=r.webrtcStuff;t.log("Creating offer (iceDone="+o.iceDone+")");let i={};!0===n.iceRestart&&(i.iceRestart=!0);t.debug(i);let a=await o.pc.createOffer(i);t.debug(a);let s={type:"offer",sdp:a.sdp};if(n.customizeSdp(s),a.sdp=s.sdp,t.log("Setting local description"),o.mySdp={type:"offer",sdp:a.sdp},await o.pc.setLocalDescription(a),o.mediaConstraints=i,!o.iceDone&&!o.trickle)return t.log("Waiting for all candidates..."),null;o.insertableStreams&&(a.e2ee=!0);return a}(e,r);r.success(n)}}catch(e){t.error(e),r.error(e)}}function N(e,n){(n=n||{}).success="function"==typeof n.success?n.success:t.noop,n.error="function"==typeof n.error?n.error:$,n.customizeSdp="function"==typeof n.customizeSdp?n.customizeSdp:t.noop;let r=n.jsep,o=S[e];if(!o||!o.webrtcStuff)return t.warn("Invalid handle"),void n.error("Invalid handle");let i=o.webrtcStuff;if(r){if(!i.pc)return t.warn("Wait, no PeerConnection?? if this is an answer, use createAnswer and not handleRemoteJsep"),void n.error("No PeerConnection: if this is an answer, use createAnswer and not handleRemoteJsep");n.customizeSdp(r),i.pc.setRemoteDescription(r).then((function(){if(t.log("Remote description accepted!"),i.remoteSdp=r.sdp,i.candidates&&i.candidates.length>0){for(let e=0;e<i.candidates.length;e++){let n=i.candidates[e];t.debug("Adding remote candidate:",n),n&&!0!==n.completed?i.pc.addIceCandidate(n):i.pc.addIceCandidate(t.endOfCandidates)}i.candidates=[]}n.success()}),n.error)}else n.error("Invalid JSEP")}async function G(e,n){if((n=n||{}).success="function"==typeof n.success?n.success:t.noop,n.error="function"==typeof n.error?n.error:t.noop,n.tracks&&!Array.isArray(n.tracks))return t.error("Tracks must be an array"),void n.error("Tracks must be an array");for(let e of n.tracks)(e.add||!e.replace&&!e.remove)&&(e.replace=!0);try{await F(e,n),n.success()}catch(e){t.error(e),n.error(e)}}async function F(e,n){let r=S[e];if(!r||!r.webrtcStuff)throw t.warn("Invalid handle, not sending anything"),"Invalid handle";let o=r.webrtcStuff;if(!o.pc)throw t.warn("Invalid PeerConnection"),"Invalid PeerConnection";let i=n.tracks;if(!i||!Array.isArray(i)||0===i.length)return;let a=!1,s={};for(let e of i){if(delete e.gumGroup,!e.type||!["audio","video"].includes(e.type))continue;if(!e.capture||e.capture instanceof MediaStreamTrack)continue;let t=e.group?e.group:"default";s[t]||(s[t]={}),s[t][e.type]||(e.gumGroup=t,s[t][e.type]=e)}let c=Object.keys(s);for(let e of c){let t=s[e];t.audio&&t.video||(t.audio&&delete t.audio.gumGroup,t.video&&delete t.video.gumGroup,delete s[e])}let d=!!n.jsep;for(let n of i){if(!n.type){t.warn("Missing track type:",n);continue}if("data"===n.type){if(o.pc.ondatachannel){t.warn("Data channel exists already, not creating another one");continue}t.log("Creating default data channel"),O(e,t.dataChanDefaultLabel,null,!1),o.pc.ondatachannel=function(n){t.log("Data channel created by Janus:",n),O(e,n.channel.label,n.channel.protocol,n.channel)};continue}if(void 0===n.add&&null===n.add&&void 0===n.remove&&null===n.remove&&void 0===n.replace&&null===n.replace&&(n.add=!0),n.add&&n.remove||n.add&&n.remove&&n.replace){t.warn("Conflicting actions for track, ignoring:",n);continue}n.add&&n.replace?(t.warn("Both add and replace provided, falling back to replace:",n),delete n.add):n.remove&&n.replace&&(t.warn("Both remove and replace provided, falling back to remove:",n),delete n.replace);let i=n.type;"screen"===n.type&&(i="video");let c=null,l=null;if(c=n.mid?o.pc.getTransceivers().find((e=>e.mid===n.mid&&e.receiver.track.kind===i)):o.pc.getTransceivers().find((e=>e.receiver.track.kind===i)),n.replace||n.remove){if(!c){t.warn("Couldn't find a transceiver for track:",n);continue}if(!c.sender){t.warn("No sender in the transceiver for track:",n);continue}l=c.sender}if(d&&!c&&(c=o.pc.getTransceivers().find((e=>e.receiver.track.kind===i)),!c)){t.warn("Couldn't find a transceiver for track:",n);continue}let u=null,p=null;if(n.remove)t.log("Removing track from PeerConnection",n),p=l.track?l.track.id:null,await l.replaceTrack(null);else if(n.capture){if(n.gumGroup&&s[n.gumGroup]&&s[n.gumGroup].stream){let e=s[n.gumGroup].stream;u="audio"===n.type?e.getAudioTracks()[0]:e.getVideoTracks()[0],delete s[n.gumGroup].stream,delete s[n.gumGroup],delete n.gumGroup}else if(n.capture instanceof MediaStreamTrack)u=n.capture;else{a||(a=!0,r.consentDialog(!0));let e=t.trackConstraints(n),o=null;if("audio"===n.type||"video"===n.type){if(n.gumGroup){let r="audio"===n.type?"video":"audio";if(s[n.gumGroup]&&s[n.gumGroup][r]){let o=s[n.gumGroup][r],i=t.trackConstraints(o);e[r]=i[r]}}o=await navigator.mediaDevices.getUserMedia(e),n.gumGroup&&e.audio&&e.video&&(s[n.gumGroup].stream=o,delete n.gumGroup)}else o=await navigator.mediaDevices.getDisplayMedia(e);u="audio"===n.type?o.getAudioTracks()[0]:o.getVideoTracks()[0]}if(n.replace){await l.replaceTrack(u);let e="sendrecv";!1!==n.recv&&"inactive"!==c.direction&&"sendonly"!==c.direction||(e="sendonly"),c.setDirection?c.setDirection(e):c.direction=e}else{if(o.myStream||(o.myStream=new MediaStream),"audio"===i||!n.simulcast&&!n.svc)l=o.pc.addTrack(u,o.myStream),c=o.pc.getTransceivers().find((e=>e.sender===l));else if(n.simulcast){if("firefox"!==t.webRTCAdapter.browserDetails.browser){t.log("Enabling rid-based simulcasting:",u);let e=y(n.simulcastMaxBitrates);c=o.pc.addTransceiver(u,{direction:"sendrecv",streams:[o.myStream],sendEncodings:n.sendEncodings||[{rid:"h",active:!0,maxBitrate:e.high},{rid:"m",active:!0,maxBitrate:e.medium,scaleResolutionDownBy:2},{rid:"l",active:!0,maxBitrate:e.low,scaleResolutionDownBy:4}]})}else if(t.log("Enabling Simulcasting for Firefox (RID)"),c=o.pc.addTransceiver(u,{direction:"sendrecv",streams:[o.myStream]}),l=c?c.sender:null,l){let e=l.getParameters();e||(e={});let t=y(n.simulcastMaxBitrates);e.encodings=n.sendEncodings||[{rid:"h",active:!0,maxBitrate:t.high},{rid:"m",active:!0,maxBitrate:t.medium,scaleResolutionDownBy:2},{rid:"l",active:!0,maxBitrate:t.low,scaleResolutionDownBy:4}],l.setParameters(e)}}else t.log("Enabling SVC ("+n.svc+"):",u),c=o.pc.addTransceiver(u,{direction:"sendrecv",streams:[o.myStream],sendEncodings:[{scalabilityMode:n.svc}]});if(l||(l=c?c.sender:null),n.codec)if("firefox"===t.webRTCAdapter.browserDetails.browser)t.warn("setCodecPreferences not supported in Firefox, ignoring codec for track:",n);else if("string"!=typeof n.codec)t.warn("Invalid codec value, ignoring for track:",n);else{let e=i+"/"+n.codec.toLowerCase(),r=RTCRtpReceiver.getCapabilities(i).codecs.filter((function(t){return t.mimeType.toLowerCase()===e}));if(r&&0!==r.length){if(c)try{c.setCodecPreferences(r)}catch(e){t.warn("Failed enforcing codec for this "+i+" track:",e)}}else t.warn("Codec not supported in this browser for this track, ignoring:",n)}if(n.bitrate)if(n.simulcast||n.svc)t.warn("Ignoring bitrate for simulcast/SVC track, use sendEncodings for that");else if(isNaN(n.bitrate)||n.bitrate<0)t.warn("Ignoring invalid bitrate for track:",n);else if(l){let e=l.getParameters();e&&e.encodings&&0!==e.encodings.length?(e.encodings[0].maxBitrate=n.bitrate,await l.setParameters(e)):t.warn("No encodings in the sender parameters, ignoring bitrate for track:",n)}if("video"===i&&n.framerate)if(n.simulcast||n.svc)t.warn("Ignoring framerate for simulcast/SVC track, use sendEncodings for that");else if(isNaN(n.framerate)||n.framerate<0)t.warn("Ignoring invalid framerate for track:",n);else if(l){let e=l.getParameters();e&&e.encodings&&0!==e.encodings.length?(e.encodings[0].maxFramerate=n.framerate,await l.setParameters(e)):t.warn("No encodings in the sender parameters, ignoring framerate for track:",n)}if(n.transforms){if(l&&n.transforms.sender){let e=null;RTCRtpSender.prototype.createEncodedStreams?e=l.createEncodedStreams():(RTCRtpSender.prototype.createAudioEncodedStreams||RTCRtpSender.prototype.createEncodedVideoStreams)&&("audio"===i?e=l.createEncodedAudioStreams():"video"===i&&(e=l.createEncodedVideoStreams())),e&&(console.log("Insertable Streams sender transform:",e),e.readableStream&&e.writableStream?e.readableStream.pipeThrough(n.transforms.sender).pipeTo(e.writableStream):e.readable&&e.writable&&e.readable.pipeThrough(n.transforms.sender).pipeTo(e.writable))}if(c&&c.receiver&&n.transforms.receiver){let e=null;RTCRtpReceiver.prototype.createEncodedStreams?e=c.receiver.createEncodedStreams():(RTCRtpReceiver.prototype.createAudioEncodedStreams||RTCRtpReceiver.prototype.createEncodedVideoStreams)&&("audio"===i?e=c.receiver.createEncodedAudioStreams():"video"===i&&(e=c.receiver.createEncodedVideoStreams())),e&&(console.log("Insertable Streams receiver transform:",e),e.readableStream&&e.writableStream?e.readableStream.pipeThrough(n.transforms.receiver).pipeTo(e.writableStream):e.readable&&e.writable&&e.readable.pipeThrough(n.transforms.receiver).pipeTo(e.writable))}}}u&&!0===n.dontStop&&(u.dontStop=!0)}if(p&&o.myStream){let e=null;if("audio"===i&&o.myStream.getAudioTracks()&&o.myStream.getAudioTracks().length)for(let n of o.myStream.getAudioTracks())n.id===p&&(e=n,t.log("Removing audio track:",e));else if("video"===i&&o.myStream.getVideoTracks()&&o.myStream.getVideoTracks().length)for(let n of o.myStream.getVideoTracks())n.id===p&&(e=n,t.log("Removing video track:",e));if(e){try{o.myStream.removeTrack(e),r.onlocaltrack(e,!1)}catch(e){t.error(e)}if(!0!==e.dontStop)try{e.stop()}catch(e){}}}if(u){o.myStream.addTrack(u),u.onended=function(e){t.log("Local track removed:",e);try{r.onlocaltrack(e.target,!1)}catch(e){t.error(e)}};try{r.onlocaltrack(u,!0)}catch(e){t.error(e)}}if(c){let e=c.direction,r=null,o=u&&c.sender.track,i=!1!==n.recv&&c.receiver.track;o&&i?r="sendrecv":o&&!i?r="sendonly":!o&&i?r="recvonly":o||i||(r="inactive"),r&&r!==e&&(t.warn("Changing direction of transceiver to "+r+" (was "+e+")",n),c.setDirection?c.setDirection(r):c.direction=r)}}a&&r.consentDialog(!1)}function U(e){let n=S[e];if(!n||!n.webrtcStuff)return t.warn("Invalid handle"),null;let r=n.webrtcStuff;if(!r.pc)return t.warn("Invalid PeerConnection"),null;let o=[],i=r.pc.getTransceivers();for(let e of i){let t=null;e.sender&&e.sender.track&&(t={mid:e.mid},t.type=e.sender.track.kind,t.id=e.sender.track.id,t.label=e.sender.track.label),t&&o.push(t)}return o}function V(e){let n=S[e];if(!n||!n.webrtcStuff)return t.warn("Invalid handle"),null;let r=n.webrtcStuff;if(!r.pc)return t.warn("Invalid PeerConnection"),null;let o=[],i=r.pc.getTransceivers();for(let e of i){let t=null;e.receiver&&e.receiver.track&&(t={mid:e.mid},t.type=e.receiver.track.kind,t.id=e.receiver.track.id,t.label=e.receiver.track.label),t&&o.push(t)}return o}function J(e,n,r,o){o="function"==typeof o?o:t.noop;let i=S[e];if(!i||!i.webrtcStuff)return t.warn("Invalid handle"),void o(0);let a=r?"remote":"local",s=i.webrtcStuff;if(s.volume[a]||(s.volume[a]={value:0}),!s.pc.getStats||"chrome"!==t.webRTCAdapter.browserDetails.browser&&"safari"!==t.webRTCAdapter.browserDetails.browser)return t.warn("Getting the "+a+" volume unsupported by browser"),void o(0);{let e=s.pc;if(n){let i=s.pc.getTransceivers().find((e=>e.mid===n&&"audio"===e.receiver.track.kind));if(!i)return t.warn("No audio transceiver with mid "+n),void o(0);if(r&&!i.receiver)return t.warn("Remote transceiver track unavailable"),void o(0);if(!r&&!i.sender)return t.warn("Local transceiver track unavailable"),void o(0);e=r?i.receiver:i.sender}return e.getStats().then((function(e){e.forEach((function(e){e&&"audio"===e.kind&&(r&&!e.remoteSource||!r&&"media-source"!==e.type||o(e.audioLevel?e.audioLevel:0))}))})),s.volume[a].value}}function W(e,n,r){let o=S[e];if(!o||!o.webrtcStuff)return t.warn("Invalid handle"),!0;let i=o.webrtcStuff;if(!i.pc)return t.warn("Invalid PeerConnection"),!0;if(!i.myStream)return t.warn("Invalid local MediaStream"),!0;if(r){if(!i.myStream.getVideoTracks()||0===i.myStream.getVideoTracks().length)return t.warn("No video track"),!0;if(n){let e=i.pc.getTransceivers().find((e=>e.mid===n&&"video"===e.receiver.track.kind));return e?e.sender&&e.sender.track?!e.sender.track.enabled:(t.warn("No video sender with mid "+n),!0):(t.warn("No video transceiver with mid "+n),!0)}return!i.myStream.getVideoTracks()[0].enabled}if(!i.myStream.getAudioTracks()||0===i.myStream.getAudioTracks().length)return t.warn("No audio track"),!0;if(n){let e=i.pc.getTransceivers().find((e=>e.mid===n&&"audio"===e.receiver.track.kind));return e?e.sender&&e.sender.track?!e.sender.track.enabled:(t.warn("No audio sender with mid "+n),!0):(t.warn("No audio transceiver with mid "+n),!0)}return!i.myStream.getAudioTracks()[0].enabled}function z(e,n,r,o){let i=S[e];if(!i||!i.webrtcStuff)return t.warn("Invalid handle"),!1;let a=i.webrtcStuff;if(!a.pc)return t.warn("Invalid PeerConnection"),!1;if(!a.myStream)return t.warn("Invalid local MediaStream"),!1;if(r){if(!a.myStream.getVideoTracks()||0===a.myStream.getVideoTracks().length)return t.warn("No video track"),!1;if(n){let e=a.pc.getTransceivers().find((e=>e.mid===n&&"video"===e.receiver.track.kind));if(!e)return t.warn("No video transceiver with mid "+n),!1;if(!e.sender||!e.sender.track)return t.warn("No video sender with mid "+n),!1;e.sender.track.enabled=!o}else for(const e of a.myStream.getVideoTracks())e.enabled=!o}else{if(!a.myStream.getAudioTracks()||0===a.myStream.getAudioTracks().length)return t.warn("No audio track"),!1;if(n){let e=a.pc.getTransceivers().find((e=>e.mid===n&&"audio"===e.receiver.track.kind));if(!e)return t.warn("No audio transceiver with mid "+n),!1;if(!e.sender||!e.sender.track)return t.warn("No audio sender with mid "+n),!1;e.sender.track.enabled=!o}else for(const e of a.myStream.getAudioTracks())e.enabled=!o}return!0}function B(e,n){let r=S[e];if(!r||!r.webrtcStuff)return t.warn("Invalid handle"),"Invalid handle";let o=r.webrtcStuff;if(!o.pc)return"Invalid PeerConnection";if(o.pc.getStats){let e=o.pc,r=n||"default";if(n){let r=o.pc.getTransceivers().find((e=>e.mid===n&&"video"===e.receiver.track.kind));if(!r)return t.warn("No video transceiver with mid "+n),"No video transceiver with mid "+n;if(!r.receiver)return t.warn("No video receiver with mid "+n),"No video receiver with mid "+n;e=r.receiver}return o.bitrate[r]||(o.bitrate[r]={timer:null,bsnow:null,bsbefore:null,tsnow:null,tsbefore:null,value:"0 kbits/sec"}),o.bitrate[r].timer?o.bitrate[r].value:(t.log("Starting bitrate timer"+(n?" for mid "+n:"")+" (via getStats)"),o.bitrate[r].timer=setInterval((function(){e.getStats().then((function(e){e.forEach((function(e){if(!e)return;let n=!1;if(("video"===e.mediaType||e.id.toLowerCase().indexOf("video")>-1)&&"inbound-rtp"===e.type&&e.id.indexOf("rtcp")<0?n=!0:"ssrc"!=e.type||!e.bytesReceived||"VP8"!==e.googCodecName&&""!==e.googCodecName||(n=!0),n)if(o.bitrate[r].bsnow=e.bytesReceived,o.bitrate[r].tsnow=e.timestamp,null===o.bitrate[r].bsbefore||null===o.bitrate[r].tsbefore)o.bitrate[r].bsbefore=o.bitrate[r].bsnow,o.bitrate[r].tsbefore=o.bitrate[r].tsnow;else{let e=o.bitrate[r].tsnow-o.bitrate[r].tsbefore;"safari"===t.webRTCAdapter.browserDetails.browser&&(e/=1e3);let n=Math.round(8*(o.bitrate[r].bsnow-o.bitrate[r].bsbefore)/e);"safari"===t.webRTCAdapter.browserDetails.browser&&(n=parseInt(n/1e3)),o.bitrate[r].value=n+" kbits/sec",o.bitrate[r].bsbefore=o.bitrate[r].bsnow,o.bitrate[r].tsbefore=o.bitrate[r].tsnow}}))}))}),1e3),"0 kbits/sec")}return t.warn("Getting the video bitrate unsupported by browser"),"Feature unsupported by browser"}function q(e,n,r){let o=S[e];if(!o||!o.webrtcStuff)return void t.warn("Invalid handle");let i=o.webrtcStuff;if(!i.pc)return void t.warn("Invalid PeerConnection");let a=i.pc.getTransceivers().find((e=>e.mid===n));if(!a)return void t.warn("No transceiver with mid",n);if(!a.sender)return void t.warn("No sender for transceiver with mid",n);let s=a.sender.getParameters();s&&s.encodings&&0!==s.encodings.length?s.encodings.length>1?t.warn("Ignoring bitrate for simulcast track, use sendEncodings for that"):isNaN(r)||r<0?t.warn("Invalid bitrate (must be a positive integer)"):(s.encodings[0].maxBitrate=r,a.sender.setParameters(s)):t.warn("No parameters encodings")}function $(e){t.error("WebRTC error:",e)}function H(e,o){t.log("Cleaning WebRTC stuff");let i=S[e];if(!i)return;let a=i.webrtcStuff;if(a){if(!0===o){let o={janus:"hangup",transaction:t.randomString(12)};i.token&&(o.token=i.token),h&&(o.apisecret=h),t.debug("Sending hangup request (handle="+e+"):"),t.debug(o),n?(o.session_id=C,o.handle_id=e,r.send(JSON.stringify(o))):t.httpAPICall(c+"/"+C+"/"+e,{verb:"POST",withCredentials:p,body:o})}a.volume&&(a.volume.local&&a.volume.local.timer&&clearInterval(a.volume.local.timer),a.volume.remote&&a.volume.remote.timer&&clearInterval(a.volume.remote.timer));for(let e in a.bitrate)a.bitrate[e].timer&&clearInterval(a.bitrate[e].timer);a.bitrate={},!a.streamExternal&&a.myStream&&(t.log("Stopping local stream tracks"),t.stopAllTracks(a.myStream)),a.streamExternal=!1,a.myStream=null;try{a.pc.close()}catch(e){}a.pc=null,a.candidates=null,a.mySdp=null,a.remoteSdp=null,a.iceDone=!1,a.dataChannel={},a.dtmfSender=null,a.insertableStreams=!1}i.oncleanup()}I(e),t.getServer=function(){return c},t.isConnected=function(){return b},t.reconnect=function(e){(e=e||{}).success="function"==typeof e.success?e.success:t.noop,e.error="function"==typeof e.error?e.error:t.noop,e.reconnect=!0,I(e)},t.getSessionId=function(){return C},t.getInfo=function(e){!function(e){if((e=e||{}).success="function"==typeof e.success?e.success:t.noop,e.error="function"==typeof e.error?e.error:t.noop,t.log("Getting info on Janus instance"),!b)return t.warn("Is the server down? (connected=false)"),void e.error("Is the server down? (connected=false)");let o=t.randomString(12),i={janus:"info",transaction:o};m&&(i.token=m);h&&(i.apisecret=h);if(n)return k[o]=function(n){t.log("Server info:"),t.debug(n),"server_info"!==n.janus&&t.error("Ooops: "+n.error.code+" "+n.error.reason),e.success(n)},void r.send(JSON.stringify(i));t.httpAPICall(c,{verb:"POST",withCredentials:p,body:i,success:function(n){t.log("Server info:"),t.debug(n),"server_info"!==n.janus&&t.error("Ooops: "+n.error.code+" "+n.error.reason),e.success(n)},error:function(n,r){t.error(n+":",r),""===r?e.error(n+": Is the server down?"):e.error(n+": "+r)}})}(e)},t.destroy=function(a){!function(a){(a=a||{}).success="function"==typeof a.success?a.success:t.noop,a.error="function"==typeof a.error?a.error:t.noop;let s=!0===a.unload,d=!0;void 0!==a.notifyDestroyed&&null!==a.notifyDestroyed&&(d=!0===a.notifyDestroyed);let l=!0===a.cleanupHandles;if(t.log("Destroying session "+C+" (unload="+s+")"),!C)return t.warn("No session to destroy"),a.success(),void(d&&e.destroyed());if(l)for(let e in S)A(e,{noRequest:!0});if(!b)return t.warn("Is the server down? (connected=false)"),C=null,void a.success();let u={janus:"destroy",transaction:t.randomString(12)};m&&(u.token=m);h&&(u.apisecret=h);if(s)return n?(r.onclose=null,r.close(),r=null):navigator.sendBeacon(c+"/"+C,JSON.stringify(u)),t.log("Destroyed session:"),C=null,b=!1,a.success(),void(d&&e.destroyed());if(n){u.session_id=C;let t=function(){for(let e in o)r.removeEventListener(e,o[e]);r.removeEventListener("message",n),r.removeEventListener("error",s),i&&clearTimeout(i),r.close()},n=function(n){let r=JSON.parse(n.data);r.session_id==u.session_id&&r.transaction==u.transaction&&(t(),a.success(),d&&e.destroyed())},s=function(){t(),a.error("Failed to destroy the server: Is the server down?"),d&&e.destroyed()};return r.addEventListener("message",n),r.addEventListener("error",s),void(1===r.readyState?r.send(JSON.stringify(u)):s())}t.httpAPICall(c+"/"+C,{verb:"POST",withCredentials:p,body:u,success:function(n){t.log("Destroyed session:"),t.debug(n),C=null,b=!1,"success"!==n.janus&&t.error("Ooops: "+n.error.code+" "+n.error.reason),a.success(),d&&e.destroyed()},error:function(n,r){t.error(n+":",r),C=null,b=!1,a.success(),d&&e.destroyed()}})}(a)},t.attach=function(e){!function(e){if((e=e||{}).success="function"==typeof e.success?e.success:t.noop,e.error="function"==typeof e.error?e.error:t.noop,e.dataChannelOptions=e.dataChannelOptions||{ordered:!0},e.consentDialog="function"==typeof e.consentDialog?e.consentDialog:t.noop,e.iceState="function"==typeof e.iceState?e.iceState:t.noop,e.mediaState="function"==typeof e.mediaState?e.mediaState:t.noop,e.webrtcState="function"==typeof e.webrtcState?e.webrtcState:t.noop,e.slowLink="function"==typeof e.slowLink?e.slowLink:t.noop,e.onmessage="function"==typeof e.onmessage?e.onmessage:t.noop,e.onlocaltrack="function"==typeof e.onlocaltrack?e.onlocaltrack:t.noop,e.onremotetrack="function"==typeof e.onremotetrack?e.onremotetrack:t.noop,e.ondata="function"==typeof e.ondata?e.ondata:t.noop,e.ondataopen="function"==typeof e.ondataopen?e.ondataopen:t.noop,e.oncleanup="function"==typeof e.oncleanup?e.oncleanup:t.noop,e.ondetached="function"==typeof e.ondetached?e.ondetached:t.noop,!b)return t.warn("Is the server down? (connected=false)"),void e.error("Is the server down? (connected=false)");let o=e.plugin;if(!o)return t.error("Invalid plugin"),void e.error("Invalid plugin");let i=e.opaqueId,a=e.loopIndex,s=e.token?e.token:m,d=t.randomString(12),l={janus:"attach",plugin:o,opaque_id:i,loop_index:a,transaction:d};s&&(l.token=s);h&&(l.apisecret=h);if(n)return k[d]=function(n){if(t.debug(n),"success"!==n.janus)return t.error("Ooops: "+n.error.code+" "+n.error.reason),void e.error("Ooops: "+n.error.code+" "+n.error.reason);let r=n.data.id;t.log("Created handle: "+r);let i={session:w,plugin:o,id:r,token:s,detached:!1,webrtcStuff:{started:!1,myStream:null,streamExternal:!1,mySdp:null,mediaConstraints:null,pc:null,dataChannelOptions:e.dataChannelOptions,dataChannel:{},dtmfSender:null,trickle:!0,iceDone:!1,bitrate:{}},getId:function(){return r},getPlugin:function(){return o},getVolume:function(e,t){return J(r,e,!0,t)},getRemoteVolume:function(e,t){return J(r,e,!0,t)},getLocalVolume:function(e,t){return J(r,e,!1,t)},isAudioMuted:function(e){return W(r,e,!1)},muteAudio:function(e){return z(r,e,!1,!0)},unmuteAudio:function(e){return z(r,e,!1,!1)},isVideoMuted:function(e){return W(r,e,!0)},muteVideo:function(e){return z(r,e,!0,!0)},unmuteVideo:function(e){return z(r,e,!0,!1)},getBitrate:function(e){return B(r,e)},setMaxBitrate:function(e,t){return q(r,e,t)},send:function(e){_(r,e)},data:function(e){M(r,e)},dtmf:function(e){x(r,e)},consentDialog:e.consentDialog,iceState:e.iceState,mediaState:e.mediaState,webrtcState:e.webrtcState,slowLink:e.slowLink,onmessage:e.onmessage,createOffer:function(e){L(r,!0,e)},createAnswer:function(e){L(r,!1,e)},handleRemoteJsep:function(e){N(r,e)},replaceTracks:function(e){G(r,e)},getLocalTracks:function(){return U(r)},getRemoteTracks:function(){return V(r)},onlocaltrack:e.onlocaltrack,onremotetrack:e.onremotetrack,ondata:e.ondata,ondataopen:e.ondataopen,oncleanup:e.oncleanup,ondetached:e.ondetached,hangup:function(e){H(r,!0===e)},detach:function(e){A(r,e)}};S[r]=i,e.success(i)},l.session_id=C,void r.send(JSON.stringify(l));t.httpAPICall(c+"/"+C,{verb:"POST",withCredentials:p,body:l,success:function(n){if(t.debug(n),"success"!==n.janus)return t.error("Ooops: "+n.error.code+" "+n.error.reason),void e.error("Ooops: "+n.error.code+" "+n.error.reason);let r=n.data.id;t.log("Created handle: "+r);let i={session:w,plugin:o,id:r,token:s,detached:!1,webrtcStuff:{started:!1,myStream:null,streamExternal:!1,mySdp:null,mediaConstraints:null,pc:null,dataChannelOptions:e.dataChannelOptions,dataChannel:{},dtmfSender:null,trickle:!0,iceDone:!1,bitrate:{}},getId:function(){return r},getPlugin:function(){return o},getVolume:function(e,t){return J(r,e,!0,t)},getRemoteVolume:function(e,t){return J(r,e,!0,t)},getLocalVolume:function(e,t){return J(r,e,!1,t)},isAudioMuted:function(e){return W(r,e,!1)},muteAudio:function(e){return z(r,e,!1,!0)},unmuteAudio:function(e){return z(r,e,!1,!1)},isVideoMuted:function(e){return W(r,e,!0)},muteVideo:function(e){return z(r,e,!0,!0)},unmuteVideo:function(e){return z(r,e,!0,!1)},getBitrate:function(e){return B(r,e)},setMaxBitrate:function(e,t){return q(r,e,t)},send:function(e){_(r,e)},data:function(e){M(r,e)},dtmf:function(e){x(r,e)},consentDialog:e.consentDialog,iceState:e.iceState,mediaState:e.mediaState,webrtcState:e.webrtcState,slowLink:e.slowLink,onmessage:e.onmessage,createOffer:function(e){L(r,!0,e)},createAnswer:function(e){L(r,!1,e)},handleRemoteJsep:function(e){N(r,e)},replaceTracks:function(e){G(r,e)},getLocalTracks:function(){return U(r)},getRemoteTracks:function(){return V(r)},onlocaltrack:e.onlocaltrack,onremotetrack:e.onremotetrack,ondata:e.ondata,ondataopen:e.ondataopen,oncleanup:e.oncleanup,ondetached:e.ondetached,hangup:function(e){H(r,!0===e)},detach:function(e){A(r,e)}};S[r]=i,e.success(i)},error:function(n,r){t.error(n+":",r),""===r?e.error(n+": Is the server down?"):e.error(n+": "+r)}})}(e)}}t.useDefaultDependencies=function(n){let r=n&&n.fetch||fetch,o=n&&n.Promise||Promise,i=n&&n.WebSocket||WebSocket;return{newWebSocket:function(e,t){return new i(e,t)},extension:n&&n.extension||e,isArray:function(e){return Array.isArray(e)},webRTCAdapter:n&&n.adapter||adapter,httpAPICall:function(e,n){let i={method:n.verb,headers:{Accept:"application/json, text/plain, */*"},cache:"no-cache"};"POST"===n.verb&&(i.headers["Content-Type"]="application/json"),void 0!==n.withCredentials&&(i.credentials=!0===n.withCredentials?"include":n.withCredentials?n.withCredentials:"omit"),n.body&&(i.body=JSON.stringify(n.body));let a=r(e,i).catch((function(e){return o.reject({message:"Probably a network error, is the server down?",error:e})}));if(n.timeout){let e=new o((function(e,t){let r=setTimeout((function(){return clearTimeout(r),t({message:"Request timed out",timeout:n.timeout})}),n.timeout)}));a=o.race([a,e])}return a.then((function(e){return e.ok?typeof n.success==typeof t.noop?e.json().then((function(e){try{n.success(e)}catch(e){t.error("Unhandled httpAPICall success callback error",e)}}),(function(t){return o.reject({message:"Failed to parse response body",error:t,response:e})})):void 0:o.reject({message:"API call failed",response:e})})).catch((function(e){typeof n.error==typeof t.noop&&n.error(e.message||"<< internal error >>",e)})),a}}},t.useOldDependencies=function(n){let r=n&&n.jQuery||jQuery,o=n&&n.WebSocket||WebSocket;return{newWebSocket:function(e,t){return new o(e,t)},isArray:function(e){return r.isArray(e)},extension:n&&n.extension||e,webRTCAdapter:n&&n.adapter||adapter,httpAPICall:function(e,n){let o=void 0!==n.body?{contentType:"application/json",data:JSON.stringify(n.body)}:{},i=void 0!==n.withCredentials?{xhrFields:{withCredentials:n.withCredentials}}:{};return r.ajax(r.extend(o,i,{url:e,type:n.verb,cache:!1,dataType:"json",async:n.async,timeout:n.timeout,success:function(e){typeof n.success==typeof t.noop&&n.success(e)},error:function(e,r,o){typeof n.error==typeof t.noop&&n.error(r,o)}}))}}},t.mediaToTracks=function(e){let t=[];if(e){if(!e.keepAudio&&!1!==e.audio&&(void 0===e.audio||e.audio||e.audioSend||e.audioRecv||e.addAudio||e.replaceAudio||e.removeAudio)){let n={type:"audio"};e.removeAudio?n.remove=!0:(e.addAudio?n.add=!0:e.replaceAudio&&(n.replace=!0),!1!==e.audioSend&&(n.capture=e.audio||!0),!1!==e.audioRecv&&(n.recv=!0)),(n.remove||n.capture||n.recv)&&t.push(n)}if(!e.keepVideo&&!1!==e.video&&(void 0===e.video||e.video||e.videoSend||e.videoRecv||e.addVideo||e.replaceVideo||e.removeVideo)){let n={type:"video"};e.removeVideo?n.remove=!0:(e.addVideo?n.add=!0:e.replaceVideo&&(n.replace=!0),!1!==e.videoSend&&(n.capture=e.video||!0,["screen","window","desktop"].includes(n.capture)&&(n.type="screen",n.capture={video:{}},e.screenshareFrameRate&&(n.capture.frameRate=e.screenshareFrameRate),e.screenshareHeight&&(n.capture.height=e.screenshareHeight),e.screenshareWidth&&(n.capture.width=e.screenshareWidth))),!1!==e.videoRecv&&(n.recv=!0)),(n.remove||n.capture||n.recv)&&t.push(n)}e.data&&t.push({type:"data"})}else t.push({type:"audio",capture:!0,recv:!0}),t.push({type:"video",capture:!0,recv:!0});return t},t.trackConstraints=function(e){let n={};if(!e||!e.capture)return n;if("audio"===e.type)n.audio=e.capture;else if("video"===e.type)if((e.simulcast||e.svc)&&!0===e.capture&&(e.capture="hires"),!0===e.capture||"object"==typeof e.capture)n.video=e.capture;else{let r=0,o=0;"lowres"===e.capture?(r=320,o=240):"lowres-16:9"===e.capture?(r=320,o=180):"hires"===e.capture||"hires-16:9"===e.capture||"hdres"===e.capture?(r=1280,o=720):"fhdres"===e.capture?(r=1920,o=1080):"4kres"===e.capture?(r=3840,o=2160):"stdres"===e.capture?(r=640,o=480):"stdres-16:9"===e.capture?(r=640,o=360):(t.log("Default video setting is stdres 4:3"),r=640,o=480),n.video={width:{ideal:r},height:{ideal:o}}}else"screen"===e.type&&(n.video=e.capture);return n},t.noop=function(){},t.dataChanDefaultLabel="JanusDataChannel",t.endOfCandidates=null,t.stopAllTracks=function(e){try{let n=e.getTracks();for(let e of n)t.log(e),e&&!0!==e.dontStop&&e.stop()}catch(e){}},t.init=function(e){if((e=e||{}).callback="function"==typeof e.callback?e.callback:t.noop,t.initDone)e.callback();else{if(void 0===console.log&&(console.log=function(){}),t.trace=t.noop,t.debug=t.noop,t.vdebug=t.noop,t.log=t.noop,t.warn=t.noop,t.error=t.noop,!0===e.debug||"all"===e.debug)t.trace=console.trace.bind(console),t.debug=console.debug.bind(console),t.vdebug=console.debug.bind(console),t.log=console.log.bind(console),t.warn=console.warn.bind(console),t.error=console.error.bind(console);else if(Array.isArray(e.debug))for(let n of e.debug)switch(n){case"trace":t.trace=console.trace.bind(console);break;case"debug":t.debug=console.debug.bind(console);break;case"vdebug":t.vdebug=console.debug.bind(console);break;case"log":t.log=console.log.bind(console);break;case"warn":t.warn=console.warn.bind(console);break;case"error":t.error=console.error.bind(console);break;default:console.error("Unknown debugging option '"+n+"' (supported: 'trace', 'debug', 'vdebug', 'log', warn', 'error')")}t.log("Initializing library");let n=e.dependencies||t.useDefaultDependencies();t.isArray=n.isArray,t.webRTCAdapter=n.webRTCAdapter,t.httpAPICall=n.httpAPICall,t.newWebSocket=n.newWebSocket,t.extension=n.extension,t.extension.init(),t.listDevices=function(e,n){e="function"==typeof e?e:t.noop,n||(n={audio:!0,video:!0}),t.isGetUserMediaAvailable()?navigator.mediaDevices.getUserMedia(n).then((function(n){navigator.mediaDevices.enumerateDevices().then((function(r){t.debug(r),e(r),t.stopAllTracks(n)}))})).catch((function(n){t.error(n),e([])})):(t.warn("navigator.mediaDevices unavailable"),e([]))},t.attachMediaStream=function(e,n){try{e.srcObject=n}catch(r){try{e.src=URL.createObjectURL(n)}catch(e){t.error("Error attaching stream to element",e)}}},t.reattachMediaStream=function(e,n){try{e.srcObject=n.srcObject}catch(r){try{e.src=n.src}catch(e){t.error("Error reattaching stream to element",e)}}};let r=["iPad","iPhone","iPod"].indexOf(navigator.platform)>=0?"pagehide":"beforeunload",o=window["on"+r];if(window.addEventListener(r,(function(){t.log("Closing window");for(let e in t.sessions)t.sessions[e]&&t.sessions[e].destroyOnUnload&&(t.log("Destroying session "+e),t.sessions[e].destroy({unload:!0,notifyDestroyed:!1}));o&&"function"==typeof o&&o()})),t.safariVp8=!1,"safari"===t.webRTCAdapter.browserDetails.browser&&t.webRTCAdapter.browserDetails.version>=605)if(RTCRtpSender&&RTCRtpSender.getCapabilities&&RTCRtpSender.getCapabilities("video")&&RTCRtpSender.getCapabilities("video").codecs&&RTCRtpSender.getCapabilities("video").codecs.length){for(let e of RTCRtpSender.getCapabilities("video").codecs)if(e&&e.mimeType&&"video/vp8"===e.mimeType.toLowerCase()){t.safariVp8=!0;break}t.safariVp8?t.log("This version of Safari supports VP8"):t.warn("This version of Safari does NOT support VP8: if you're using a Technology Preview, try enabling the 'WebRTC VP8 codec' setting in the 'Experimental Features' Develop menu")}else{let e=new RTCPeerConnection({});e.createOffer({offerToReceiveVideo:!0}).then((function(n){t.safariVp8=-1!==n.sdp.indexOf("VP8"),t.safariVp8?t.log("This version of Safari supports VP8"):t.warn("This version of Safari does NOT support VP8: if you're using a Technology Preview, try enabling the 'WebRTC VP8 codec' setting in the 'Experimental Features' Develop menu"),e.close(),e=null}))}t.initDone=!0,e.callback()}},t.isWebrtcSupported=function(){return!!window.RTCPeerConnection},t.isGetUserMediaAvailable=function(){return navigator.mediaDevices&&navigator.mediaDevices.getUserMedia},t.randomString=function(e){let t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",n="";for(let r=0;r<e;r++){let e=Math.floor(Math.random()*t.length);n+=t.charAt(e)}return n};let n={wssHost:"",loginData:{token:"",agentCode:"",sipPwd:"",sipServer:"",webrtcServer:""},websocket:"",socket:"",callId:null,conference:null,conferenceList:[],code:0,callType:null,janus:null,sipcall:null,stream:null,status:"LOGIN",statusDropList:[{text:"空闲",type:"READY"},{text:"忙碌",type:"NOT_READY"}],logoutDropList:[{text:"登出",type:"LOGOUT"}],timers:{callTimer:0,callTimerStr:"00:00:00",callTimerInterval:null},telNum:"",telNumTransfer:"",telNumConsult:"",shrink:!1,acceptMsg:"",acceptJsep:"",activeCallId:null,reconectInterval:null,afterPhoneInterval:null},r={},o={initHost(){let e=n.loginData.wsServer;n.wssHost=e},addAudio(){let e=document.createElement("audio");e.id="incomingcallAudio",e.loop=!0,e.src="https://dev.voice9.com/static/beep.wav",document.body.appendChild(e);let t=document.createElement("video");t.id="peerVideo",t.autoplay=!0,document.body.appendChild(t);let n=document.createElement("video");n.id="remoteVideo",n.autoplay=!0,document.body.appendChild(n)},videoControll(e=!0){let t=document.getElementById("incomingcallAudio");e?t.play():t.pause()},connectWs(){n.websocket=`${n.wssHost}?token=${n.loginData.token}`;let e=n.websocket;if(console.log("websocket url:"+e),!window.WebSocket)return void alert("您的浏览器不支持WebSocket协议！");n.socket=new WebSocket(e);let t,r=n.socket;r.onmessage=function(e){console.log("Received: "+e.data);let t=JSON.parse(e.data);o.onmessage(t);let r=t.type;"pong"!=r&&(n.lastStatus=n.status,0!==t.code?n.status=n.lastStatus:n.status=r,n.code=t.code,n.callType=t.data&&t.data.callType,o.statusChangeFun(t),t.code)},r.onopen=function(){console.log("Info: WebSocket connection opened."),o.clearReconectStatus();let e={cmd:"LOGIN",loginType:n.loginData.loginType,agentKey:n.loginData.agentKey,workType:n.loginData.workType,time:(new Date).getTime()};n.status&&n.status.includes("TALKING")&&(e.callId=n.callId),o.echo(JSON.stringify(e)),t=window.setInterval((function(){let e="{'cmd':'ping' , 'sequence': "+(new Date).getTime()+" }";r.send(e)}),1e4)},r.onclose=function(e){console.log("Info: WebSocket connection closed, Code: "+e.code+(""==e.reason?"":", Reason: "+e.reason)),clearInterval(n.reconectInterval),clearInterval(t);[1403,1105,1416].includes(n.code)?(o.doLogout(),n.code):n.reconectInterval=setInterval((()=>{window.janus.destroy&&window.janus.destroy(),o.connectWs()}),5e3)}},statusChangeFun(e){let{type:t,message:r}=e,i=e.data;if(i&&i.callId&&(n.callId=i.callId),i&&i.conference&&(n.conference=i.conference),i&&i.conferenceList?n.conferenceList=i.conferenceList:n.conferenceList=[],"LOGIN"==t&&(o.callFun("NOT_READY"),2===n.loginData.loginType&&o.initjanus()),"AFTER"==t){if(n.loginData.afterInterval>0)return void(n.afterPhoneInterval=setTimeout((()=>{"AFTER"===n.status&&(console.log("话后自动置闲"),o.callFun("READY"))}),1e3*n.loginData.afterInterval));o.echo("{'cmd':'READY','sequence':'"+Date.now()+"'}")}},initjanus(){let e=n.loginData;if(""==e.sipServer||""==e.webrtcServer)return;let r={},i=0,a={},s=!1;console.log("sipServer = "+e.sipServer+", sipAccount = "+e.agentCode+", sipPwd = "+e.sipPwd);let c=t;n.janus=c,c.init({debug:"all",callback:function(){c.isWebrtcSupported()?(n.janus=new c({server:e.webrtcServer,success:function(){c.attach({plugin:"janus.plugin.sip",opaqueId:"voice9_"+c.randomString(16),success:function(t){n.sipcall=t,c.log("Plugin attached! ("+n.sipcall.getPlugin()+", id="+n.sipcall.getId()+")");let r={request:"register",username:"sip:"+e.agentCode+"@"+e.sipServer,authuser:e.agentCode,display_name:e.agentCode,secret:e.sipPwd,proxy:"sip:"+e.agentCode+"@"+e.sipServer};n.sipcall.send({message:r})},error:function(e){c.error("  -- Error attaching plugin...",e)},consentDialog:function(e){c.debug("Consent dialog should be "+(e?"on":"off")+" now")},iceState:function(e){c.log("ICE state changed to "+e)},mediaState:function(e,t,n){c.log("janus "+(t?"started":"stopped")+" receiving our "+e+" (mid="+n+")")},webrtcState:function(e){c.log("janus says our WebRTC PeerConnection is "+(e?"up":"down")+" now")},slowLink:function(e,t,n){c.warn("janus reports problems "+(e?"sending":"receiving")+" packets on mid "+n+" ("+t+" lost packets)")},onmessage:function(e,t){c.debug(" ::: Got a message :::",e);let r=e.call_id,i=e.result;if(i&&i.event){let a=i.event;if("registration_failed"===a)return void c.warn("Registration failed: "+i.code+" "+i.reason);if("registered"===a)c.log("Successfully registered as "+i.username+"!"),s||(s=!0,i.master_id);else if("calling"===a)c.log("Waiting for the peer to answer...");else if("incomingcall"===a)c.log("Incoming call from "+i.username+"!"),n.sipcall.callId=r,o.videoControll(!0),n.acceptMsg=e,n.acceptJsep=t,"2"==n.loginData.loginType&&(2!=n.loginData.workType&&"OUT_CALL"!=n.status&&"OUT_CALLER_RING"!=n.status||o.accept(e,t));else if("accepting"===a);else if("progress"===a)c.log("There's early media from "+i.username+", wairing for the call!",t),t&&n.sipcall.handleRemoteJsep({jsep:t});else if("accepted"===a)c.log(i.username+" accepted the call!",t),o.videoControll(!1),t&&n.sipcall.handleRemoteJsep({jsep:t}),n.sipcall.callId=r;else if("updatingcall"===a){c.log("Got re-INVITE");let e=t.sdp.indexOf("m=audio ")>-1,r=t.sdp.indexOf("m=video ")>-1,o=[];e&&!n.sipcall.doAudio&&(n.sipcall.doAudio=!0,o.push({type:"audio",capture:!0,recv:!0})),r&&!n.sipcall.doVideo&&(n.sipcall.doVideo=!0,o.push({type:"video",capture:!0,recv:!0})),n.sipcall.createAnswer({jsep:t,tracks:o,success:function(t){c.debug("Got SDP "+t.type+"! audio="+e+", video="+r+":",t);n.sipcall.send({message:{request:"update"},jsep:t})},error:function(e){c.error("WebRTC error:",e)}})}else if("message"===a){let e=i.displayname?i.displayname:i.sender,t=i.content;console.info("sender = "+e),console.info("content = "+t)}else if("info"===a){let e=i.displayname?i.displayname:i.sender,t=i.content;t=t.replace(new RegExp("<","g"),"&lt"),t=t.replace(new RegExp(">","g"),"&gt"),console.log("sender = "+e+", content = "+t)}else"notify"===a||"transfer"===a||"hangup"===a&&(c.log("Call hung up ("+i.code+" "+i.reason+")!"),o.videoControll(!1),n.sipcall.hangup())}},onlocaltrack:function(e,t){c.log("Local track "+(t?"added":"removed")+":",e);let o=e.id.replace(/[{}]/g,"");if(!t){if(n.stream=r[o],n.stream)try{let e=n.stream.getTracks();for(let t in e){let n=e[t];n&&n.stop()}}catch(e){console.error(e)}return"video"===e.kind&&(i--,0===i&&console.log("No video")),void delete r[o]}if(n.stream=r[o],!n.stream){if("audio"===e.kind);else{i++,n.stream=new MediaStream([e]),r[o]=n.stream,c.log("Created local stream:",n.stream);let t=document.getElementById("remoteVideo");c.attachMediaStream(t,n.stream)}"completed"!==n.sipcall.webrtcStuff.pc.iceConnectionState&&n.sipcall.webrtcStuff.pc.iceConnectionState}},onremotetrack:function(e,t,r){if(c.log("Remote track (mid="+t+") "+(r?"added":"removed")+":",e),r&&"audio"===e.kind){n.stream=new MediaStream([e]),a[t]=n.stream,c.log("Created remote audio stream:",n.stream);let r=document.getElementById("peerVideo");c.attachMediaStream(r,n.stream)}},oncleanup:function(){c.log(" ::: Got a cleanup notification :::"),n.sipcall&&(delete n.sipcall.callId,delete n.sipcall.doAudio),r={},i=0,a={}}})},error:function(e){c.error(e)},destroyed:function(){console.info("destroyed===========")}}),window.janus=c):console.info("No WebRTC support... ")}})},accept(e,t){(0,n.sipcall.createAnswer)({jsep:t,media:{audio:!0,video:!1},success:function(e){n.sipcall.send({message:{request:"accept"},jsep:e})},error:function(e){n.janus.error("WebRTC error:",e);n.sipcall.send({message:{request:"decline",code:480}})}})},echo(e){let t=n.socket;null!=t?(console.log("Sent: "+e),t.send(e)):alert("WebSocket connection not established, please connect.")},changeStatus(e){console.log("changeStatus active type："+e),o.echo(`{'cmd':'${e}','sequence':'1604584634704'}`),window.clearInterval(n.afterPhoneInterval)},callFun(e){if(console.log("callFun active type：",e),"MAKE_CALL"===e)return void o.echo(`{'cmd':'${e}','sequence':'1604584634704', 'display':'', 'called':'${n.telNum}', 'callType':1,"followData":{}}`);let t="4";if("TRANSFER"===e){return n.telNumTransfer.includes("@")&&(t="1"),void o.echo(`{'cmd':'${e}','sequence':'1604584634704', 'transferType':'${t}', 'transferValue':'${n.telNumTransfer}'}`)}if("CONSULT"===e){return n.telNumConsult.includes("@")&&(t="1"),void o.echo(`{'cmd':'${e}','sequence':'1604584634704', 'consultType':'${t}', 'consultValue':'${n.telNumConsult}'}`)}if("CONSULT_CANCEL"===e)return"CONSULT_TALKING"===n.status&&(e="CONSULT_STOP"),void o.echo(`{'cmd':'${e}'}`);"CONSULT_PARTY"!==e?o.echo(`{'cmd':'${e}'}`):o.echo(`{'cmd':'${e}','callId':'${n.callId}'}`)},removeRoomFun(e){o.echo(`{'cmd':'CONFERENCE_REMOVE','callId':'${e.callId}',"deviceId":"${e.deviceId}",\n"conference":"${n.conference}",\n"memberId":${e.memberId},\n"username":${e.username}}`)},clearReconectStatus(){clearInterval(n.reconectInterval)},doLogout(){o.trigger("logout")},trigger(e,t){r[e]&&r[e].forEach((e=>{e(t)}))},onmessage(e){o.trigger("message",e)}};return function(){this.init=function(e){n.loginData={...n.loginData,...e},console.log("Voice9 init",e),o.initHost(),o.connectWs(),o.addAudio()},this.logout=function(){o.doLogout(),o.changeStatus("LOGOUT"),window.janus.destroy&&window.janus.destroy()},this.setBusy=function(){o.changeStatus("NOT_READY")},this.setReady=function(){o.changeStatus("READY")},this.makeCall=function(e){n.telNum=e,o.callFun("MAKE_CALL")},this.acceptCall=function(){o.accept(n.acceptMsg,n.acceptJsep)},this.closeCall=function(){o.callFun("HANGUP_CALL")},this.phoneTransfer=function(e){n.telNumTransfer=e,o.callFun("TRANSFER")},this.phoneConsult=function(e){n.telNumConsult=e,o.callFun("CONSULT")},this.phoneConsultCancel=function(){o.callFun("CONSULT_CANCEL")},this.phoneConsultTransfer=function(e){n.telNumTransfer=e,o.callFun("TRANSFER")},this.phoneConsultParty=function(){o.callFun("CONSULT_PARTY")},this.mutePhone=function(){o.callFun("MUTE")},this.cancelMute=function(){o.callFun("MUTE_CANCEL")},this.holdTalking=function(){o.callFun("HOLD")},this.cancelHold=function(){o.callFun("HOLD_CANCEL")},this.on=function(e,t){r[e]||(r[e]=[]),r[e].push(t)},this.addEventListener=function(e,t){r[e]||(r[e]=[]),r[e].push(t)},this.off=function(e,t){if(!r[e])return t("事件不存在");delete r[e],t("事件删除成功")}}}));
